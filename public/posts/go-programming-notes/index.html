<!doctype html>
<html
  dir="ltr"
  lang="en"
  data-theme=""
  
    class="html theme--light"
  
><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <meta charset="utf-8" />
  <title>
    David Ado
        |
        Go Programming Notes
      

    

  </title>

  <meta name="generator" content="Hugo 0.125.3"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="author" content="David Ado" />
  <meta
    name="description"
    content="Full Stack Developer
Cloud Architect
"
  />
  
  
    
    
    <link
      rel="stylesheet"
      href="/scss/main.min.009f917038f30ebd1f2147e8e1dfd40fc1b799422a7869aa0da12af1fd1bf8ba.css"
      integrity="sha256-AJ&#43;RcDjzDr0fIUfo4d/UD8G3mUIqeGmqDaEq8f0b&#43;Lo="
      crossorigin="anonymous"
      type="text/css"
    />
  

  
  <link
    rel="stylesheet"
    href="/css/markupHighlight.min.73ccfdf28df555e11009c13c20ced067af3cb021504cba43644c705930428b00.css"
    integrity="sha256-c8z98o31VeEQCcE8IM7QZ688sCFQTLpDZExwWTBCiwA="
    crossorigin="anonymous"
    type="text/css"
  />
  
  
  <link
    rel="stylesheet"
    href="/fontawesome/css/fontawesome.min.7d272de35b410fb165377550cdf9c4d3a80fbbcc961e111914e4d5c0eaf5729f.css"
    integrity="sha256-fSct41tBD7FlN3VQzfnE06gPu8yWHhEZFOTVwOr1cp8="
    crossorigin="anonymous"
    type="text/css"
  />
  
  <link
    rel="stylesheet"
    href="/fontawesome/css/solid.min.55d8333481b07a08e07cf6f37319753a2b47e99f4c395394c5747b48b495aa9b.css"
    integrity="sha256-VdgzNIGwegjgfPbzcxl1OitH6Z9MOVOUxXR7SLSVqps="
    crossorigin="anonymous"
    type="text/css"
  />
  
  <link
    rel="stylesheet"
    href="/fontawesome/css/regular.min.a7448d02590b43449364b6b5922ed9af5410abb4de4238412a830316dedb850b.css"
    integrity="sha256-p0SNAlkLQ0STZLa1ki7Zr1QQq7TeQjhBKoMDFt7bhQs="
    crossorigin="anonymous"
    type="text/css"
  />
  
  <link
    rel="stylesheet"
    href="/fontawesome/css/brands.min.9ed75a5d670c953fe4df935937674b4646f92674367e9e66eb995bb04e821647.css"
    integrity="sha256-ntdaXWcMlT/k35NZN2dLRkb5JnQ2fp5m65lbsE6CFkc="
    crossorigin="anonymous"
    type="text/css"
  />
  
  <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />

  <link rel="canonical" href="http://localhost:1313/posts/go-programming-notes/" />

  
  
  
  
  <script
    type="text/javascript"
    src="/js/anatole-header.min.f9132794301a01ff16550ed66763482bd848f62243d278f5e550229a158bfd32.js"
    integrity="sha256-&#43;RMnlDAaAf8WVQ7WZ2NIK9hI9iJD0nj15VAimhWL/TI="
    crossorigin="anonymous"
  ></script>

  
    
    
    <script
      type="text/javascript"
      src="/js/anatole-theme-switcher.min.d6d329d93844b162e8bed1e915619625ca91687952177552b9b3e211014a2957.js"
      integrity="sha256-1tMp2ThEsWLovtHpFWGWJcqRaHlSF3VSubPiEQFKKVc="
      crossorigin="anonymous"
    ></script>
  

  

  


  
  <meta name="twitter:card" content="summary"><meta name="twitter:title" content="Go Programming Notes">
<meta name="twitter:description" content="This isn&rsquo;t meant to be a comprehensive set of notes so I won&rsquo;t be including much of the obvious stuff.">



  
  <meta property="og:url" content="http://localhost:1313/posts/go-programming-notes/">
  <meta property="og:site_name" content="David Ado">
  <meta property="og:title" content="Go Programming Notes">
  <meta property="og:description" content="This isn&amp;rsquo;t meant to be a comprehensive set of notes so I won&amp;rsquo;t be including much of the obvious stuff.">
  <meta property="og:locale" content="en-us">
  <meta property="og:type" content="article">
  <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-02-17T10:59:49-08:00">
    <meta property="article:modified_time" content="2024-02-17T10:59:49-08:00">



  
  
  
  
  <script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "articleSection": "posts",
        "name": "Go Programming Notes",
        "headline": "Go Programming Notes",
        "alternativeHeadline": "",
        "description": "
      
        This isn\u0026rsquo;t meant to be a comprehensive set of notes so I won\u0026rsquo;t be including much of the obvious stuff.


      


    ",
        "inLanguage": "en-us",
        "isFamilyFriendly": "true",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "http:\/\/localhost:1313\/posts\/go-programming-notes\/"
        },
        "author" : {
            "@type": "Person",
            "name": "David Ado"
        },
        "creator" : {
            "@type": "Person",
            "name": "David Ado"
        },
        "accountablePerson" : {
            "@type": "Person",
            "name": "David Ado"
        },
        "copyrightHolder" : {
            "@type": "Person",
            "name": "David Ado"
        },
        "copyrightYear" : "2024",
        "dateCreated": "2024-02-17T10:59:49.00Z",
        "datePublished": "2024-02-17T10:59:49.00Z",
        "dateModified": "2024-02-17T10:59:49.00Z",
        "publisher":{
            "@type":"Organization",
            "name": "David Ado",
            "url": "http://localhost:1313/",
            "logo": {
                "@type": "ImageObject",
                "url": "http:\/\/localhost:1313\/favicon-32x32.png",
                "width":"32",
                "height":"32"
            }
        },
        "image": 
      [
      ]

    ,
        "url" : "http:\/\/localhost:1313\/posts\/go-programming-notes\/",
        "wordCount" : "10006",
        "genre" : [ ],
        "keywords" : [ ]
    }
  </script>


</head>
<body class="body">
    <div class="wrapper">
      <aside
        
          class="wrapper__sidebar"
        
      ><div
  class="sidebar
    animated fadeInDown
  "
>
  <div class="sidebar__content">
    <div class="sidebar__introduction">
      <img
        class="sidebar__introduction-profileimage"
        src="/images/profile.jpg"
        alt="profile picture"
      />
      
        <div class="sidebar__introduction-title">
          <a href="/">David Ado</a>
        </div>
      
      <div class="sidebar__introduction-description">
        <p>Full Stack Developer<br />Cloud Architect<br /></p>
      </div>
    </div>
    <ul class="sidebar__list">
      
        <li class="sidebar__list-item">
          <a
            href="https://www.linkedin.com/in/davidado/"
            target="_blank"
            rel="noopener me"
            aria-label="Linkedin"
            title="Linkedin"
          >
            <i class="fab fa-linkedin fa-2x" aria-hidden="true"></i>
          </a>
        </li>
      
        <li class="sidebar__list-item">
          <a
            href="https://github.com/jadoint"
            target="_blank"
            rel="noopener me"
            aria-label="GitHub"
            title="GitHub"
          >
            <i class="fab fa-github fa-2x" aria-hidden="true"></i>
          </a>
        </li>
      
    </ul>
  </div><footer class="footer footer__sidebar">
  <ul class="footer__list">
    <li class="footer__item">
      &copy;
      
        David Ado
        2024
      
    </li>
    
  </ul>
</footer>
  
  <script
    type="text/javascript"
    src="/js/medium-zoom.min.1248fa75275e5ef0cbef27e8c1e27dc507c445ae3a2c7d2ed0be0809555dac64.js"
    integrity="sha256-Ekj6dSdeXvDL7yfoweJ9xQfERa46LH0u0L4ICVVdrGQ="
    crossorigin="anonymous"
  ></script>
  
    
      <script async src="https://www.googletagmanager.com/gtag/js?id=G-FZKQND180X"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-FZKQND180X');
        }
      </script>
    
  

</div>
</aside>
      <main
        
          class="wrapper__main"
        
      >
        <header class="header"><div
  class="
    animated fadeInDown
  "
>
  <a role="button" class="navbar-burger" data-target="navMenu" aria-label="menu" aria-expanded="false">
    <span aria-hidden="true" class="navbar-burger__line"></span>
    <span aria-hidden="true" class="navbar-burger__line"></span>
    <span aria-hidden="true" class="navbar-burger__line"></span>
  </a>
  <nav class="nav">
    <ul class="nav__list" id="navMenu">
      
      
        
        
          <li class="nav__list-item">
            
            <a
              
              href="/"
              
              title=""
              >Home</a
            >
          </li>
        

      
        
        
          <li class="nav__list-item">
            
            <a
              
              href="/posts/"
              
              title=""
              >Posts</a
            >
          </li>
        

      
        
        
          <li class="nav__list-item">
            
            <a
              
              href="/about/about-me"
              
              title=""
              >About</a
            >
          </li>
        

      
    </ul>
    <ul class="nav__list nav__list--end">
      
      
        <li class="nav__list-item">
          <div class="themeswitch">
            <a title="Switch Theme">
              <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
            </a>
          </div>
        </li>
      
    </ul>
  </nav>
</div>
</header>
  <div
    class="post 
      animated fadeInDown
    "
  >
    
    <div class="post__content">
      <h1>Go Programming Notes</h1>
      <p>This isn&rsquo;t meant to be a comprehensive set of notes so I won&rsquo;t be including much of the obvious stuff.</p>
<h2 id="installation">Installation</h2>
<ol>
<li>Download archive from <a href="https://go.dev/dl/">https://go.dev/dl/</a></li>
<li>Remove any previous Go installation by deleting the /usr/local/go folder (if it exists), then extract the archive you just downloaded into /usr/local, creating a fresh Go tree in /usr/local/go: <code> rm -rf /usr/local/go &amp;&amp; tar -C /usr/local -xzf go1.22.0.linux-amd64.tar.gz</code></li>
<li>Add /usr/local/go/bin to the <code>PATH</code> environment variable. You can do this by adding the following line to your $HOME/.profile or /etc/profile (for a system-wide installation): <code>export PATH=$PATH:/usr/local/go/bin</code></li>
<li>Run <code>source $HOME/.profile</code> to apply changes immediately.</li>
<li>Verify that you&rsquo;ve installed Go by opening a command prompt and typing the following command: <code>go version</code></li>
</ol>
<h2 id="environment">Environment</h2>
<ul>
<li><code>go build -o hello_world hello.go</code> builds a binary named <em>hello_world</em> that can be distributed to other people.</li>
<li>Install third party tools using <code>go install</code>.</li>
<li><code>go install github.com/rakyll/hey@latest</code> installs the <em>hey</em> tool that load tests an HTTP endpoint (ex: <code>hey https://www.google.com</code>).</li>
<li><code>goimports</code> is the enhanced version of <code>go fmt</code> that not only automatically formats your Go code to standard formatting, but also cleans up your import statements (sorts in alphabetical order, removes unused imports, and guesses at unspecified imports).</li>
<li>Install with <code>go install golang.org/x/tools/cmd/goimports@latest</code> then run <code>goimports -l -w .</code> across your project (<code>-l</code> prints the files with incorrect formatting to the console, <code>-w</code> modifies the files in-place, <code>.</code> specifies the current directory and all subdirectories).</li>
<li>The Go linter enforces code style. Install with <code>go install golang.org/x/lint/golint@latest</code> and run with <code>golint ./...</code> which runs the linter over your entire project.</li>
<li><code>go vet</code> catches mistakes such as passing the wrong number of parameters or unused variables.</li>
<li><code>golangci-lint run</code> combines <code>golint</code> and <code>go vet</code> and can be configured to run multiple linters.</li>
</ul>
<p><strong>Makefiles</strong></p>
<ul>
<li>Makefiles help automate tasks. Sample makefile:</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">.DEFAULT GOAL := build
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">fmt:
</span></span><span class="line"><span class="cl">	go fmt ./...
</span></span><span class="line"><span class="cl">.PHONY: fmt
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">lint: fmt
</span></span><span class="line"><span class="cl">	golint ./...
</span></span><span class="line"><span class="cl">.PHONY: lint
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">vet: fmt
</span></span><span class="line"><span class="cl">	go vet ./...
</span></span><span class="line"><span class="cl">.PHONY:vet
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">build: vet
</span></span><span class="line"><span class="cl">	go build hello.go
</span></span><span class="line"><span class="cl">.PHONY:build
</span></span></code></pre></div><ul>
<li><code>build: vet</code> specifies that <code>vet</code> must run first before <code>go build</code>.</li>
<li>.PHONY keeps <em>make</em> from getting confused if a directory with the same name as the target is ever created in the project.</li>
</ul>
<h2 id="primitive-types-and-declarations">Primitive Types and Declarations</h2>
<ul>
<li>Avoid declaring package level variables whose values change sit it can be difficult to track the changes made to it. Generally, only declare variables in the package blog that are effectively immutable.</li>
</ul>
<h2 id="composite-types">Composite Types</h2>
<p><strong>Arrays</strong></p>
<ul>
<li>To declare an array of 3 <em>ints</em> pre-filled with zero values: <code>var x [3]int</code>.</li>
<li>Arrays are rarely used especially since Go considers the <em>size</em> of the array to be part of the <em>type</em> of the array so a [3]int is a different type from a [4]int.</li>
<li>Also, a variable can&rsquo;t be used to specify the size of an array because types must be resolved at compile time.</li>
</ul>
<p><strong>Slices</strong></p>
<ul>
<li>To declare a slice literal: <code>var x = []int{10, 20, 30}</code>.</li>
<li>Declaring a slice literal with <code>var x = []int{1, 3:6}</code> creates a slice of 5 ints with the following values: <code>[1, 0, 0, 6]</code>.</li>
<li><code>len(slice)</code> returns the length of a slice.</li>
<li><code>x = append(x, 5, 6, 7)</code> appends 5, 6, 7 to the end of the slice <code>x</code>.</li>
<li><code>x = append(x, y...)</code> appends slice <code>y</code> to the end of slice <code>x</code>.</li>
<li><code>cap(x)</code> returns the capacity of slice <code>x</code> but is used far less often than <code>len</code>.</li>
<li><code>make</code> can set length and capacity.</li>
<li><code>x := make([]int, 5)</code> creates an int slice with a length and capacity of 5 so all elements are initialized to 0.</li>
<li>If you try to do <code>x = append(x, 10)</code> to above, you will end up with the slice [0 0 0 0 0 10].</li>
<li><code>x := make([]int, 0, 10)</code> creates an int slice of length 0 and capacity 10 so appending 10 to this slice would result in the expected slice of [10].</li>
<li><strong>Slice Declarations</strong>
<ul>
<li><code>var data []int</code> declares a slice that might stay <em>nil</em>.</li>
<li><code>var x = []int{}</code> declares a zero-length slice which is non-nil where <code>x == nil</code> returns <em>false</em>. This way of slice declaration is most useful when converting a slice to JSON.</li>
</ul>
</li>
<li>Slices share storage in most cases so taking a slice from a slice means that changing one slice, changes the other.</li>
<li>Slicing slices combined with <em>append</em> can be very confusing so try to avoid it.</li>
<li>Use a three-part slice expression to prevent <em>append</em> from sharing capacity between slices (<code>z := x[2:4:4]</code>)</li>
<li>A slice taken from an array also shares its memory.</li>
<li><strong>copy</strong> can create a slice independent from the original. <code>z := copy(y, x)</code> copies <code>x</code> into <code>y</code>.</li>
</ul>
<p><strong>Strings, Runes, and Bytes</strong></p>
<ul>
<li>Be careful of indexing into a string where you aren&rsquo;t sure if every character is a byte long. Trying to access a multi-byte character using an index may result in garbled text.</li>
<li>A string can be converted back and forth to a slice of bytes or a slice of runes (<code>[]bytes(str)</code> or <code>[]rune(str)</code>).</li>
<li>Most data in Go is read and written as a sequence of bytes to the most common string type converstion is back and forth with a slice of bytes. Slices of runes are uncommon.</li>
<li>Instead of using slice and index expressions with strings, use the functions in the <em>strings</em> and <em>unicode/utf8</em> packages in the standard library.</li>
</ul>
<p><strong>Maps</strong></p>
<ul>
<li><code>var nilMap map[string]int</code> results in a map with the zero value of <em>nil</em> and attempting to write to a <em>nil</em> map causes a panic.</li>
<li><code>totalWins := map[string]int{}</code> results in an empty map literal which is not the same as a <em>nil</em> map because you can read and write to it.</li>
<li><code>ages := make(map[name]int, 10)</code> creates a map with length 0 but with the default size of 10. It can also grow past its initial size.</li>
<li>The keys for a map can be of any comparable type so it can&rsquo;t be a slice or another map.</li>
<li>Reading the value of a non-existent key returns the zero value of the type of value stored so that a map of ints would return 0 for a non-existent key.</li>
<li>Maps return two values: <code>v, ok := m[&quot;hello&quot;]</code> where if <em>ok</em> is <em>false</em>, the key is not present.</li>
<li><code>delete(m, &quot;hello&quot;)</code> deletes the <em>hello</em> key from <em>m</em>.</li>
<li>To use a <em>map</em> as a <em>set</em>, enter all values as a map key and either set the value as a bool or an empty struct.</li>
<li>The bool is simpler to work with but uses a byte of memory whereas an empty struct does not. Use bool for simplicity unless you have a very large set and saving a byte of data per entry makes a difference.</li>
</ul>
<p><strong>Structs</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">type person struct {
</span></span><span class="line"><span class="cl">	name string
</span></span><span class="line"><span class="cl">	age int
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">// Order matters
</span></span><span class="line"><span class="cl">julia := person{
</span></span><span class="line"><span class="cl">	&#34;Julia&#34;,
</span></span><span class="line"><span class="cl">	40,
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">// The preferred way
</span></span><span class="line"><span class="cl">beth := person{
</span></span><span class="line"><span class="cl">	age: 30,
</span></span><span class="line"><span class="cl">	name: &#34;Beth&#34;,
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">beth.age = 31
</span></span></code></pre></div><p><strong>Anonymous Structs</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">pet := struct{
</span></span><span class="line"><span class="cl">	name string
</span></span><span class="line"><span class="cl">	kind string
</span></span><span class="line"><span class="cl">}{
</span></span><span class="line"><span class="cl">	name: &#34;Spot&#34;,
</span></span><span class="line"><span class="cl">	kind: &#34;dog&#34;,
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></div><ul>
<li>Anonymous structs are most often used for:
<ul>
<li>Converting external data into a struct.</li>
<li>Converting a struct into external data like JSON or a protocol buffer. (<em>marshaling</em>)</li>
</ul>
</li>
</ul>
<p><strong>Comparing and Converting Structs</strong></p>
<ul>
<li>Structs can be comparable if they are entirely composed of comparable types, have the same field names, order of those name, and types.</li>
<li>Anonymous structs can be comparable if they also have the same field names, order, and types.</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="n">f</span> <span class="p">:</span><span class="o">=</span> <span class="n">person</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">name</span><span class="p">:</span> <span class="s2">&#34;Bob&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="n">age</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">var</span> <span class="n">g</span> <span class="n">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">name</span> <span class="n">string</span>
</span></span><span class="line"><span class="cl">	<span class="n">age</span> <span class="ne">int</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">g</span> <span class="o">=</span> <span class="n">f</span>
</span></span><span class="line"><span class="cl"><span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">f</span> <span class="o">==</span> <span class="n">g</span><span class="p">)</span>
</span></span></code></pre></div><h2 id="blocks-shadows-and-control-structures">Blocks, Shadows, and Control Structures</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">x</span> <span class="p">:</span><span class="o">=</span> <span class="mi">10</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">5</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">//</span> <span class="n">Prints</span> <span class="mi">10</span>
</span></span><span class="line"><span class="cl">		<span class="n">x</span> <span class="p">:</span><span class="o">=</span> <span class="mi">5</span>
</span></span><span class="line"><span class="cl">		<span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">//</span> <span class="n">Prints</span> <span class="mi">5</span>
</span></span><span class="line"><span class="cl">		<span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="p">:</span><span class="o">=</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">20</span>
</span></span><span class="line"><span class="cl">		<span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="o">//</span> <span class="n">Prints</span> <span class="mi">7</span> <span class="mi">20</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">//</span> <span class="n">Prints</span> <span class="mi">10</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><ul>
<li>The <em>x</em> in the inner <em>if</em> block shadows the <em>x</em> in the outer block.</li>
<li>Accidental shadowing frequently occurs when assigning to multiple variables since you only need on new variable to use the := assignment operator.</li>
</ul>
<h2 id="detecting-shadowed-variables">Detecting Shadowed Variables</h2>
<ul>
<li><code>go install golang.org/x/tools/go/analysis/passes/shadow/cmd/shadow@latest</code></li>
<li><code>shadow ./...</code></li>
<li>Makefile:</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">vet:
</span></span><span class="line"><span class="cl">	go vet ./...
</span></span><span class="line"><span class="cl">	shadow ./...
</span></span><span class="line"><span class="cl">.PHONY:vet
</span></span></code></pre></div><ul>
<li>Running this will give you the line: <code>declaration of &quot;x&quot; shadows declaration at line 6</code></li>
</ul>
<p><strong>if</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">if n := rand.Intn(10); n == 0 {
</span></span><span class="line"><span class="cl">	fmt.Println(&#34;That&#39;s too low&#34;)
</span></span><span class="line"><span class="cl">} else if n &gt; 5 {
</span></span><span class="line"><span class="cl">	fmt.Println(&#34;that&#39;s too big: &#34;, n)
</span></span><span class="line"><span class="cl">} else {
</span></span><span class="line"><span class="cl">	fmt.Println(&#34;That&#39;s a good number:&#34;, n)
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">fmt.Println(n) // Results in error undefined: n
</span></span></code></pre></div><ul>
<li><em>n</em> is scoped to the entirety of <em>if</em> block and nowhere else.</li>
</ul>
<p><strong>for</strong></p>
<ul>
<li>To mimic a do-while loop:</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">for {
</span></span><span class="line"><span class="cl">	// Do stuff
</span></span><span class="line"><span class="cl">	if !condition {
</span></span><span class="line"><span class="cl">		break
</span></span><span class="line"><span class="cl">	}
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></div><ul>
<li>Consider using the <em>continue</em> statement to break up nested <em>if</em>s in a <em>for</em> loop.</li>
<li>To range over just the map keys, just leave off the value key: <code>for k := range m</code>. Most commonly used for sets.</li>
<li>Ranging over a map will not result in the same order of keys every time.
<ul>
<li>This is done to remind programmers that map keys are not stored in order.</li>
<li>This is also a security fix for an attack called a <em>Hash DoS</em> where an attacker sends data where all of the keys hash to the same bucket to slow down a server.</li>
</ul>
</li>
<li>However, using <em>fmt.Println</em> will output maps with their keys in ascending order to ease debugging.</li>
<li>When ranging over strings, the index and the number of bytes from the beginning of the string but is of type <em>rune</em>.</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">str := &#34;hello&#34;
</span></span><span class="line"><span class="cl">for i, r := range str {
</span></span><span class="line"><span class="cl">	fmt.Println(i, r, string(r))
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">// Prints:
</span></span><span class="line"><span class="cl">// 0 104 h
</span></span><span class="line"><span class="cl">// 1 101 e
</span></span><span class="line"><span class="cl">// 2 108 l
</span></span><span class="line"><span class="cl">// 3 108 l
</span></span><span class="line"><span class="cl">// 4 111 o
</span></span></code></pre></div><p><strong>switch</strong></p>
<ul>
<li>Switches don&rsquo;t require the <em>break</em> statement in Go.</li>
<li>Regular switches only allows you to check a value for equality.</li>
<li>Blank switches allows you to use any boolean comparison for each case.</li>
<li>However, if you find yourself using a blank switch where every comparison is for equality, you&rsquo;re better off just having a switch with an expression:</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">// Don&#39;t do this
</span></span><span class="line"><span class="cl">switch {
</span></span><span class="line"><span class="cl">case a == 2:
</span></span><span class="line"><span class="cl">	fmt.Println(a)
</span></span><span class="line"><span class="cl">case a == 3:
</span></span><span class="line"><span class="cl">	fmt.Println(a)
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">// Do this instead
</span></span><span class="line"><span class="cl">switch a {
</span></span><span class="line"><span class="cl">case 2:
</span></span><span class="line"><span class="cl">	fmt.Println(a)
</span></span><span class="line"><span class="cl">case 3:
</span></span><span class="line"><span class="cl">	fmt.Println(a)
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></div><h2 id="functions">Functions</h2>
<ul>
<li>Functions that take another function as an input parameter or a return value are <em>higher order functions</em>.</li>
</ul>
<p><strong>defer</strong></p>
<ul>
<li>The code within <em>defer</em> closures run after the return statement.</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">tx, err := db.BeginTx(ctx, ni)
</span></span><span class="line"><span class="cl">if err != nil {
</span></span><span class="line"><span class="cl">	return err
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">defer func() {
</span></span><span class="line"><span class="cl">	if err == nil {
</span></span><span class="line"><span class="cl">		err = tx.Commit()
</span></span><span class="line"><span class="cl">	}
</span></span><span class="line"><span class="cl">	if err != nil {
</span></span><span class="line"><span class="cl">		tx.Rollback()
</span></span><span class="line"><span class="cl">	}
</span></span><span class="line"><span class="cl">}()
</span></span></code></pre></div><ul>
<li>The parentheses after the anonymous function is what executes it. It&rsquo;s a compile time error to leave it out.</li>
<li><em>defer</em> is something like the <em>finally</em> clause in other languages. The downside to these resource cleanup blocks is that they create another level of indentation in your function making code harder to read.
<ul>
<li>In a 2017 research paper, out of 11 code characteristics, only nesting depth and lack of structure markedly influence complexity.</li>
</ul>
</li>
</ul>
<p><strong>Go Is Call By Value</strong></p>
<ul>
<li>Everything passed as parameter to a function is a value. Even structs changed within a function do not affect the original struct.</li>
<li>The behavior is different for maps and slices even though those are also passed in as values. Maps and slices are implemented as pointers to structs in the underlying Go platform so the values passed are the values of those pointers.</li>
</ul>
<h2 id="pointers">Pointers</h2>
<ul>
<li>A pointer is a variable whose contents are the address in memory where another variable is stored.</li>
<li>Pointers always take up the same size in memory because all it stores is a location in memory where values are stored.</li>
<li>A pointer that doesn&rsquo;t point to anything has zeroes as values and the zero value of a pointer is <em>nil</em>.</li>
<li>The <em>&amp;</em> is the <em>address</em> operator. It precedes a value type and returns the memory address of where the value is stored.</li>
<li>The * is the <em>indirection</em> operator. It precedes a variable of pointer type and returns the pointed-to value (also called <em>dereferencing</em>).
<ul>
<li>Make sure that a pointer is non-nil before dereferencing it or the program panics in the attempt.</li>
</ul>
</li>
<li>If a struct has a field that takes a pointer, you can either create a variable as a pointer and set it in the struct, or you can create a helper function that returns a pointer type.</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="n">type</span> <span class="n">person</span> <span class="n">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">FirstName</span> <span class="n">string</span>
</span></span><span class="line"><span class="cl">	<span class="n">MiddleName</span> <span class="o">*</span><span class="n">string</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">func</span> <span class="n">stringp</span><span class="p">(</span><span class="n">s</span> <span class="n">string</span><span class="p">)</span> <span class="o">*</span><span class="n">string</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="o">&amp;</span><span class="n">s</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">p</span> <span class="p">:</span><span class="o">=</span> <span class="n">person</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">FirstName</span><span class="p">:</span> <span class="s2">&#34;Pat&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="n">MiddleName</span><span class="p">:</span> <span class="n">stringp</span><span class="p">(</span><span class="s2">&#34;Perry&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><ul>
<li>Most of the time, you should pass in values instead of pointers since it makes it easier to understand how and when your data is modified. It also reduces the amount of work that the garbage collector has to do.</li>
</ul>
<p><strong>Pointers Indicate Mutable Parameters</strong></p>
<ul>
<li>The lack of immutable declarations in Go might seem problematic, but the ability to choose between value and pointer parameter types addresses the issue.</li>
<li>Since Go is a call by value language, the values passed to functions are copies and the immutability of the original data is guaranteed (maps and slices notwithstanding).</li>
<li>When you pass a <em>nil</em> pointer to a function, you cannot make the value non-nil. You can only reassign the value if there was a value already assigned to the pointer.
<ul>
<li>Remember that Go is call by value and the values passed are copies so trying to change the pointer in the function is just changing a copy of it.</li>
</ul>
</li>
<li>Since the pointer passed into a function is just a copy of the original, you have to <em>dereference</em> the pointer to set it to a new value. Dereferencing puts the new value in the memory location pointed to by both the original and the copy.</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="o">//</span> <span class="n">Doesn</span><span class="s1">&#39;t work</span>
</span></span><span class="line"><span class="cl"><span class="k">func</span> <span class="n">failedUpdate</span><span class="p">(</span><span class="n">px</span> <span class="o">*</span><span class="ne">int</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">x2</span> <span class="p">:</span><span class="o">=</span> <span class="mi">20</span>
</span></span><span class="line"><span class="cl">	<span class="n">px</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">x2</span> <span class="o">//</span> <span class="n">you</span> <span class="n">just</span> <span class="n">updated</span> <span class="n">the</span> <span class="n">copy</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">//</span> <span class="n">Works</span>
</span></span><span class="line"><span class="cl"><span class="k">func</span> <span class="n">update</span><span class="p">(</span><span class="n">px</span> <span class="o">*</span><span class="ne">int</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="o">//</span> <span class="n">dereferencing</span> <span class="n">takes</span> <span class="n">you</span> <span class="n">to</span> <span class="n">the</span> <span class="n">original</span> <span class="n">memory</span> <span class="n">location</span>
</span></span><span class="line"><span class="cl">	<span class="o">//</span> <span class="n">then</span> <span class="n">the</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">that</span> <span class="n">location</span> <span class="n">is</span> <span class="n">changed</span><span class="o">.</span>
</span></span><span class="line"><span class="cl">	<span class="o">*</span><span class="n">px</span> <span class="o">=</span> <span class="mi">20</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><strong>Pointers Are a Last Resort</strong></p>
<ul>
<li>Rather than passing a pointer to a struct as a return value of a function, have the function instantiate and return the struct.</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="o">//</span> <span class="n">Don</span><span class="s1">&#39;t do this</span>
</span></span><span class="line"><span class="cl"><span class="k">func</span> <span class="n">MakeFoo</span><span class="p">(</span><span class="n">f</span> <span class="o">*</span><span class="n">Foo</span><span class="p">)</span> <span class="n">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">f</span><span class="o">.</span><span class="n">Field1</span> <span class="o">=</span> <span class="s2">&#34;val&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">f</span><span class="o">.</span><span class="n">Field2</span> <span class="o">=</span> <span class="mi">20</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">//</span> <span class="n">Do</span> <span class="n">this</span> <span class="n">instead</span>
</span></span><span class="line"><span class="cl"><span class="k">func</span> <span class="n">MakeFoo</span><span class="p">()</span> <span class="p">(</span><span class="n">Foo</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">f</span> <span class="p">:</span><span class="o">=</span> <span class="n">Foo</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">Field1</span><span class="p">:</span> <span class="s2">&#34;val&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="n">Field2</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">f</span><span class="p">,</span> <span class="n">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><ul>
<li>The only time you should use pointer parameters to modify a variable is when the function expects an interface. You see this pattern when unmarshalling JSON.
<ul>
<li>This pattern seems common since JSON operations are done frequently but this is the exception.</li>
</ul>
</li>
</ul>
<p><strong>Pointer Passing Performance</strong></p>
<p><strong>Passing a pointer into a function</strong></p>
<ul>
<li>The time to pass a pointer into a function is constant for all data sizes, roughly one nanosecond, because the size of a pointer is the same for all data types.</li>
<li>Passing a value into a function takes longer as the data gets larger. It takes about a millisecond once the value gets to around 10 megabytes of data.</li>
</ul>
<p><strong>Returning a pointer from a function</strong></p>
<ul>
<li>For data structures that are smaller than a megabyte, it is <em>slower</em> to return a pointer type than a value type. A 100-byte data structure take around 10 nanoseconds to be returned but a pointer to that data structure takes about 30 nanoseconds.</li>
<li>For data structures larger than a megabyte, the performance flips. It takes nearly 2 milliseconds to return 10 megabytes of data but around half a millisecond to return a pointer to it.</li>
<li>If you are passing megabytes of data between functions, consider using a pointer even if the data is meant to be immutable.</li>
</ul>
<p><strong>The Zero Value Versus No Value</strong></p>
<ul>
<li>Resist the temptation to use a pointer field to indicate no value. If you are not going to modify the value, you should use a value type instead, paired with a boolean (ex. comma ok, comma error idioms).</li>
</ul>
<p><strong>The Difference Between Maps and Slices</strong></p>
<p><strong>Maps</strong></p>
<ul>
<li>Maps are implemented as a pointer to a struct in the Go runtime so passing a map to a function means you are copying a pointer.</li>
<li>Avoid using maps for input parameters or return values because they say nothing about what values are contained within and the only way to know is to trace through the code.</li>
<li>They are also bad from an immutability standpoint because the only way to know what ended up in the map is to trace through all of the functions that interact with it.</li>
<li>Rather than a map, use a struct.</li>
</ul>
<p><strong>Slices</strong></p>
<ul>
<li>Slices have complicated behavior: slices modified within a function is reflected in the original variable, but using <em>append</em> fails to change the length in the original.</li>
<li>Slices are implemented as structs with three fields: length (int), capacity (int), and a pointer to a block of memory.
<ul>
<li>When slices are passed to a function, the length, capacity, and pointer are copied.</li>
<li>Using <em>append</em> on the slice within the function, adds an element in the block of memory through the pointer and increases the length of the slice <em>copy</em>.</li>
<li>The original slice can&rsquo;t see the new elements added into memory because the length and capacity of the original slice are unchanged so the new elements are effectively hidden.</li>
</ul>
</li>
<li>By default, you should assume that a slice is not modified by a function and if it does, it should be documented in the function.</li>
</ul>
<p><strong>Slices as Buffers</strong></p>
<ul>
<li>When reading data from an external resource, many languages use code like this:</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">r = open_resource()
</span></span><span class="line"><span class="cl">while r.has_data() {
</span></span><span class="line"><span class="cl">	data_chunk = r.next_chunk()
</span></span><span class="line"><span class="cl">	process(data_chunk)
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">close(r)
</span></span></code></pre></div><ul>
<li>The problem is that every loop allocates another <em>data_chunk</em> even though each one is only used once creating unnecessary memory allocations.</li>
<li>We can create a slice of bytes once and use it as a buffer instead:</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">file, err := os.Open(filename)
</span></span><span class="line"><span class="cl">if err != nil {
</span></span><span class="line"><span class="cl">	return err
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">defer file.Close()
</span></span><span class="line"><span class="cl">data := make([]byte, 100)
</span></span><span class="line"><span class="cl">for {
</span></span><span class="line"><span class="cl">	count, err := file.Read(data)
</span></span><span class="line"><span class="cl">	if err != nil {
</span></span><span class="line"><span class="cl">		return err
</span></span><span class="line"><span class="cl">	}
</span></span><span class="line"><span class="cl">	if count == 0 {
</span></span><span class="line"><span class="cl">		return nil
</span></span><span class="line"><span class="cl">	}
</span></span><span class="line"><span class="cl">	process(data[:count])
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></div><p><strong>Reducing the Garbage Collector&rsquo;s Workload</strong></p>
<ul>
<li>To store something on the stack, you have to know exactly how big it is at compile time.</li>
<li>To allocate data a pointer points to onto the stack, there are several conditions:
<ul>
<li>It must be a local variable whose data size is known at compile time.</li>
<li>The pointer cannot be return from the function.</li>
<li>If the pointer is passed into a function, the compiler must be able to ensure that these conditions still hold.</li>
</ul>
</li>
<li>If the pointer variable is returned, the memory that the pointer points to will no longer be valid when the function exits.</li>
<li>If the compiler determines that data can&rsquo;t be stored on the stack, the data <em>escaped</em> the stack and is stored on the heap.</li>
<li>Once there are no more pointers pointing to data on the heap, the data is garbage collected.</li>
<li><em>Escape analysis</em> by the Go compiler isn&rsquo;t perfect and is tuned for lower latency (finish garbage scan fast) instead of higher throughput (find as much garbage as possible in a single scan) to keep response times low.</li>
<li>Each garbage collection cycle is designed to take less than 500 microseconds.</li>
<li>It&rsquo;s best to generate less garbage to be collected due to the garbage collector&rsquo;s emphasis on speed instead of throughput so it&rsquo;s best to store as much as possible on the stack.</li>
<li>A slice of structs in Go can be read faster from memory than a slice of pointers to structs because the slice of structs are laid out sequentially in memory whereas pointer data is scattered across RAM. The speed difference is roughly two orders of magnitude.</li>
<li>Contrast this with Java where objects are implemented as pointers meaning only the pointers are stored on the stack. Lists are actually a pointer to an array of pointers and though it looks like a linear data structure, reading it actually involves bouncing around through memory.</li>
<li>Go encourages you to use pointers sparingly to reduce garbage collector workload by storing as much as possible on the stack.</li>
</ul>
<h2 id="types-methods-and-interfaces">Types, Methods, and Interfaces</h2>
<p><strong>Pointer Receiver and Value Receivers</strong></p>
<ul>
<li>If your method modifies the receiver, you <em>must</em> use a pointer receiver.</li>
<li>If your method needs to handle <em>nil</em> instances, it <em>must</em> use a pointer receiver.</li>
<li>If your method doesn&rsquo;t modify the receiver, you <em>can</em> use a value receiver.</li>
<li>However, when a type has <em>any</em> pointer receiver methods, a common practice is to be consistent and use pointer receivers for all methods.</li>
<li>Avoid writing getters and setters. Go encourages you to directly access a field.</li>
</ul>
<p><strong>Code Your Methods for nil Instances</strong></p>
<ul>
<li>If a method uses a pointer receiver, handle the possibility of a <em>nil</em> instance.</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="o">//</span> <span class="n">Binary</span> <span class="n">tree</span> <span class="ow">in</span> <span class="n">Go</span>
</span></span><span class="line"><span class="cl"><span class="n">type</span> <span class="n">IntTree</span> <span class="n">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">val</span>         <span class="ne">int</span>
</span></span><span class="line"><span class="cl">	<span class="n">left</span><span class="p">,</span> <span class="n">right</span> <span class="o">*</span><span class="n">IntTree</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">func</span> <span class="p">(</span><span class="n">it</span> <span class="o">*</span><span class="n">IntTree</span><span class="p">)</span> <span class="n">Insert</span><span class="p">(</span><span class="n">val</span> <span class="ne">int</span><span class="p">)</span> <span class="o">*</span><span class="n">IntTree</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="n">it</span> <span class="o">==</span> <span class="n">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="o">&amp;</span><span class="n">IntTree</span><span class="p">(</span><span class="n">val</span><span class="p">:</span> <span class="n">val</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="n">val</span> <span class="o">&lt;</span> <span class="n">it</span><span class="o">.</span><span class="n">left</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">it</span><span class="o">.</span><span class="n">left</span> <span class="o">=</span> <span class="n">it</span><span class="o">.</span><span class="n">left</span><span class="o">.</span><span class="n">Insert</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="n">it</span><span class="o">.</span><span class="n">val</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">it</span><span class="o">.</span><span class="n">right</span> <span class="o">=</span> <span class="n">it</span><span class="o">.</span><span class="n">right</span><span class="o">.</span><span class="n">Insert</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">it</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">func</span> <span class="p">(</span><span class="n">it</span> <span class="o">*</span><span class="n">IntTree</span><span class="p">)</span> <span class="n">Contains</span><span class="p">(</span><span class="n">val</span> <span class="ne">int</span><span class="p">)</span> <span class="ne">bool</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">switch</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="n">it</span> <span class="o">==</span> <span class="n">nil</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="bp">false</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="n">val</span> <span class="o">&lt;</span> <span class="n">it</span><span class="o">.</span><span class="n">val</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="n">it</span><span class="o">.</span><span class="n">left</span><span class="o">.</span><span class="n">Contains</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="n">it</span><span class="o">.</span><span class="n">val</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="n">it</span><span class="o">.</span><span class="n">right</span><span class="o">.</span><span class="n">Contains</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">default</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="bp">true</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><ul>
<li>Pointer receivers work just like pointer function parameters; it&rsquo;s a copy of the pointer that&rsquo;s passed into the method. So if you have a <em>nil</em> pointer, you can&rsquo;t make the original pointer non-nil.</li>
</ul>
<p><strong>Functions Versus Methods</strong></p>
<ul>
<li>If your logic depends on values configured at startup or that change while the program is running, the those values should be stored in a struct and the logic be implemented as a method.</li>
</ul>
<p><strong>Types Are Executable Documentation</strong></p>
<ul>
<li>It&rsquo;s clearer for someone reading your code when a method has a parameter of type <em>Percentage</em> than of type <em>int</em> and it&rsquo;s harder to be invoked with an invalid value.</li>
</ul>
<p><strong>iota is for Enumerations (Sometimes)</strong></p>
<ul>
<li>When using <em>iota</em>, the best practice is to first define a type based on <em>int</em> that will represent all of the valid values.</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="n">type</span> <span class="n">MailCategory</span> <span class="ne">int</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">const</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="n">Uncategorized</span> <span class="n">MailCategory</span> <span class="o">=</span> <span class="n">iota</span>
</span></span><span class="line"><span class="cl">	<span class="n">Personal</span>
</span></span><span class="line"><span class="cl">	<span class="n">Spam</span>
</span></span><span class="line"><span class="cl">	<span class="n">Social</span>
</span></span><span class="line"><span class="cl">	<span class="n">Advertisements</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span></code></pre></div><ul>
<li>Use <em>iota</em> only if the constants will only be referred to internally in the program. If the values are explicitly defined elsewhere, use those values instead.</li>
</ul>
<p><strong>Use Embedding for Composition</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="n">type</span> <span class="n">Employee</span> <span class="n">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">Name</span>    <span class="n">string</span>
</span></span><span class="line"><span class="cl">	<span class="n">ID</span>      <span class="n">string</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">func</span> <span class="p">(</span><span class="n">e</span> <span class="n">Employee</span><span class="p">)</span> <span class="n">Description</span><span class="p">()</span> <span class="n">string</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Sprintf</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">%s</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">)&#34;</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">ID</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">type</span> <span class="n">Manager</span> <span class="n">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">Employee</span> <span class="o">//</span> <span class="n">This</span> <span class="n">is</span> <span class="n">an</span> <span class="n">embedded</span> <span class="n">field</span>
</span></span><span class="line"><span class="cl">	<span class="n">Reports</span> <span class="p">[]</span><span class="n">Employee</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">func</span> <span class="p">(</span><span class="n">m</span> <span class="n">Manager</span><span class="p">)</span> <span class="n">FindNewEmployees</span><span class="p">()</span> <span class="p">[]</span><span class="n">Employee</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="o">//</span> <span class="k">do</span> <span class="n">business</span> <span class="n">logic</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">m</span> <span class="p">:</span><span class="o">=</span> <span class="n">Manager</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">Employee</span><span class="p">:</span> <span class="n">Employee</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">Name</span><span class="p">:</span> <span class="s2">&#34;Bob Loblaw&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="n">ID</span><span class="p">:</span>   <span class="s2">&#34;12345&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="p">},</span>
</span></span><span class="line"><span class="cl">		<span class="n">Reports</span><span class="p">:</span> <span class="p">[]</span><span class="n">Employee</span><span class="p">{},</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">ID</span><span class="p">)</span>            <span class="o">//</span> <span class="nb">prints</span> <span class="mi">12345</span>
</span></span><span class="line"><span class="cl">	<span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">Description</span><span class="p">())</span> <span class="o">//</span> <span class="nb">prints</span> <span class="n">Bob</span> <span class="n">Loblaw</span> <span class="p">(</span><span class="mi">12345</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><ul>
<li>Any fields or methods declared on an embedded field are promoted to the containing struct and can be invoked directly on it (ex. <code>m.Description()</code>).</li>
<li>If a containing struct has fields or methods with the same name as an embedded field, you need to refer to the embedded field:</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">type Inner struct {
</span></span><span class="line"><span class="cl">	X int
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">type Outer struct {
</span></span><span class="line"><span class="cl">	Inner
</span></span><span class="line"><span class="cl">	X int
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">o := Outer {
</span></span><span class="line"><span class="cl">	Inner: Inner {
</span></span><span class="line"><span class="cl">		X: 10,
</span></span><span class="line"><span class="cl">	},
</span></span><span class="line"><span class="cl">	X: 20,
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">fmt.Println(o.X)      // prints 20
</span></span><span class="line"><span class="cl">fmt.Printn(o.Inner.X) // prints 10
</span></span></code></pre></div><p><strong>Interfaces</strong></p>
<ul>
<li>Interfaces are usually named with &ldquo;er&rdquo; endings (ex. fmt.Stringer, io.Reader, io.Closer).</li>
</ul>
<p><strong>Interfaces Are Type-Safe Duck Typing</strong></p>
<ul>
<li>Interfaces are implemented <em>implicitly</em>: as long as a concrete type contains all of the methods of an interface, it automatically implements that interface.</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="n">type</span> <span class="n">LogicProvider</span> <span class="n">struct</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">func</span> <span class="p">(</span><span class="n">lp</span> <span class="n">LogicProvider</span><span class="p">)</span> <span class="n">Process</span><span class="p">(</span><span class="n">data</span> <span class="n">string</span><span class="p">)</span> <span class="n">string</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="o">//</span> <span class="n">business</span> <span class="n">logic</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">type</span> <span class="n">Logic</span> <span class="n">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">Process</span><span class="p">(</span><span class="n">data</span> <span class="n">string</span><span class="p">)</span> <span class="n">string</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">type</span> <span class="n">Client</span> <span class="n">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">L</span> <span class="n">Logic</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">func</span> <span class="p">(</span><span class="n">c</span> <span class="n">Client</span><span class="p">)</span> <span class="n">Program</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="o">//</span> <span class="n">get</span> <span class="n">data</span> <span class="n">from</span> <span class="n">somewhere</span>
</span></span><span class="line"><span class="cl">	<span class="n">c</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">c</span> <span class="p">:</span><span class="o">=</span> <span class="n">Client</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">L</span><span class="p">:</span> <span class="n">LogicProvider</span><span class="p">{},</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">c</span><span class="o">.</span><span class="n">Program</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><ul>
<li>Using interfaces encourages the <em>decorator pattern</em> where a factory function takes in an instance of an interface and returns another type that implements the same interface.</li>
</ul>
<p><strong>Embedding and Interfaces</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">type Reader interface {
</span></span><span class="line"><span class="cl">	Read(p []byte) (n int, err error)
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">type Closer interface {
</span></span><span class="line"><span class="cl">	Close() error
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">type ReadCloser interface {
</span></span><span class="line"><span class="cl">	Reader
</span></span><span class="line"><span class="cl">	Closer
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></div><p><strong>Accept Interfaces, Return Structs</strong></p>
<ul>
<li>Business logic invoked by your functions should be invoked via interfaces, but the output of your functions should be a concrete type.</li>
<li>Adding new methods and fields to a returned concrete type won&rsquo;t break existing code.</li>
<li>Adding a new method to an interface means that all existing implementations of that interface would need to be updated.</li>
<li>As for garbage collection:
<ul>
<li>Returning a struct is good to avoid a heap allocation.</li>
<li>However, a heap allocation occurs for each interface parameter.</li>
<li>It&rsquo;s up to you to figure out the trade-off between better abstraction and better performance though it&rsquo;s often better to lean towards the side of readability and maintainability.</li>
</ul>
</li>
</ul>
<p><strong>The Empty Interface</strong></p>
<ul>
<li>An empty interface type (<em>interface{}</em>) just states that the variable can store any value whose type implements zero or more methods which just happens to match every type in Go.</li>
<li>If you see a function takes in an empty interface, it&rsquo;s likely using reflection to populate or read the value.</li>
<li>Avoid using <em>interface{}</em> since situations that use it should be rare.</li>
</ul>
<p><strong>Type Assertions and Type Switches</strong></p>
<ul>
<li>Type assertions can only be applied to interface types and are checked at runtime while type conversions are applies to both concrete types and interfaces and checked at compile time.</li>
<li>Conversions change, assertions reveal.</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="n">type</span> <span class="n">MyInt</span> <span class="ne">int</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">var</span> <span class="n">i</span> <span class="n">interface</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">	<span class="k">var</span> <span class="n">mine</span> <span class="n">MyInt</span> <span class="o">=</span> <span class="mi">20</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="o">=</span> <span class="n">mine</span>
</span></span><span class="line"><span class="cl">	<span class="n">i2</span><span class="p">,</span> <span class="n">ok</span> <span class="p">:</span><span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="p">(</span><span class="n">MyInt</span><span class="p">)</span> <span class="o">//</span> <span class="n">type</span> <span class="n">assertion</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="o">!</span><span class="n">ok</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="o">//</span> <span class="n">always</span> <span class="n">check</span> <span class="k">for</span> <span class="n">errors</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s2">&#34;unexpected type for %v&#34;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">i2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><ul>
<li>If an interface could be multiple types, use a type switch.</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="k">func</span> <span class="n">doThings</span><span class="p">(</span><span class="n">i</span> <span class="n">interface</span><span class="p">{})</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="o">//</span> <span class="n">it</span><span class="s1">&#39;s idiomatic to assign the variable being</span>
</span></span><span class="line"><span class="cl">	<span class="o">//</span> <span class="n">switched</span> <span class="n">to</span> <span class="n">a</span> <span class="n">variable</span> <span class="n">of</span> <span class="n">the</span> <span class="n">same</span> <span class="n">name</span><span class="o">.</span>
</span></span><span class="line"><span class="cl">	<span class="k">switch</span> <span class="n">i</span> <span class="p">:</span><span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="n">nil</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="o">//</span> <span class="n">i</span> <span class="n">is</span> <span class="n">nil</span><span class="p">,</span> <span class="n">type</span> <span class="n">is</span> <span class="n">interface</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="ne">int</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="o">//</span> <span class="n">type</span> <span class="ne">int</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="n">MyInt</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="o">//</span> <span class="n">type</span> <span class="n">MyInt</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="n">io</span><span class="o">.</span><span class="n">Reader</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="o">//</span> <span class="n">type</span> <span class="n">io</span><span class="o">.</span><span class="n">Reader</span>
</span></span><span class="line"><span class="cl">	<span class="n">default</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="o">//</span> <span class="n">unknown</span> <span class="n">so</span> <span class="n">i</span> <span class="n">is</span> <span class="n">of</span> <span class="n">type</span> <span class="n">interface</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><strong>Implicit Interfaces Make Dependency Injection Easier</strong></p>
<ul>
<li>Dependency injection is the concept that your code should explicitly specify the functionality it needs to perform its task.</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="o">//</span> <span class="n">Logger</span> <span class="n">utility</span> <span class="n">function</span>
</span></span><span class="line"><span class="cl"><span class="k">func</span> <span class="n">LogOutput</span><span class="p">(</span><span class="n">message</span> <span class="n">string</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">//</span> <span class="n">Data</span> <span class="n">store</span>
</span></span><span class="line"><span class="cl"><span class="n">type</span> <span class="n">SimpleDataStore</span> <span class="n">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">userData</span> <span class="n">map</span><span class="p">[</span><span class="n">string</span><span class="p">]</span><span class="n">string</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">func</span> <span class="p">(</span><span class="n">sds</span> <span class="n">SimpleDataStore</span><span class="p">)</span> <span class="n">UserNameForID</span><span class="p">(</span><span class="n">userID</span> <span class="n">string</span><span class="p">)</span> <span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="ne">bool</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">name</span><span class="p">,</span> <span class="n">ok</span> <span class="p">:</span><span class="o">=</span> <span class="n">sds</span><span class="o">.</span><span class="n">userData</span><span class="p">[</span><span class="n">userID</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">name</span><span class="p">,</span> <span class="n">ok</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">//</span> <span class="n">Factory</span> <span class="n">function</span> <span class="k">for</span> <span class="n">SimpleDataStore</span>
</span></span><span class="line"><span class="cl"><span class="k">func</span> <span class="n">NewSimpleDataStore</span><span class="p">()</span> <span class="n">SimpleDataStore</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">SimpleDataStore</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">userData</span><span class="p">:</span> <span class="n">map</span><span class="p">[</span><span class="n">string</span><span class="p">]</span><span class="n">string</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="s2">&#34;1&#34;</span><span class="p">:</span> <span class="s2">&#34;Fred&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="s2">&#34;2&#34;</span><span class="p">:</span> <span class="s2">&#34;Mary&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="s2">&#34;3&#34;</span><span class="p">:</span> <span class="s2">&#34;Pat&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="p">},</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">//</span> <span class="n">Business</span> <span class="n">logic</span>
</span></span><span class="line"><span class="cl"><span class="o">//</span> <span class="n">We</span> <span class="n">don</span><span class="s1">&#39;t want to force it to depend on LogOutput or</span>
</span></span><span class="line"><span class="cl"><span class="o">//</span> <span class="n">SimpleDataStore</span> <span class="ow">in</span> <span class="k">case</span> <span class="n">we</span> <span class="n">want</span> <span class="n">to</span> <span class="n">use</span> <span class="n">a</span> <span class="n">different</span>
</span></span><span class="line"><span class="cl"><span class="o">//</span> <span class="n">logger</span> <span class="ow">or</span> <span class="n">data</span> <span class="n">store</span> <span class="n">later</span><span class="o">.</span> <span class="n">Let</span><span class="s1">&#39;s depend on behavior</span>
</span></span><span class="line"><span class="cl"><span class="o">//</span> <span class="n">instead</span> <span class="n">using</span> <span class="n">interfaces</span><span class="o">.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">type</span> <span class="n">DataStore</span> <span class="n">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">UserNameForID</span><span class="p">(</span><span class="n">userID</span> <span class="n">string</span><span class="p">)</span> <span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="ne">bool</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">type</span> <span class="n">Logger</span> <span class="n">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">Log</span><span class="p">(</span><span class="n">message</span> <span class="n">string</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">//</span> <span class="n">LogOutput</span> <span class="n">doesn</span><span class="s1">&#39;t meet the Logger interface since it doesn&#39;</span><span class="n">t</span>
</span></span><span class="line"><span class="cl"><span class="o">//</span> <span class="n">define</span> <span class="n">the</span> <span class="n">Log</span> <span class="n">function</span><span class="o">.</span> <span class="n">We</span> <span class="n">can</span> <span class="n">turn</span> <span class="n">the</span> <span class="n">LogOutput</span> <span class="n">function</span>
</span></span><span class="line"><span class="cl"><span class="o">//</span> <span class="n">into</span> <span class="n">a</span> <span class="n">function</span> <span class="n">type</span> <span class="n">instead</span> <span class="n">to</span> <span class="n">attach</span> <span class="n">the</span> <span class="n">Log</span> <span class="n">function</span> <span class="n">to</span> <span class="n">it</span><span class="o">.</span>
</span></span><span class="line"><span class="cl"><span class="n">type</span> <span class="n">LoggerAdapter</span> <span class="k">func</span><span class="p">(</span><span class="n">message</span> <span class="n">string</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">func</span> <span class="p">(</span><span class="n">lg</span> <span class="n">LoggerAdapter</span><span class="p">)</span> <span class="n">Log</span><span class="p">(</span><span class="n">message</span> <span class="n">string</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">lg</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">//</span> <span class="n">Business</span> <span class="n">logic</span> <span class="n">implementation</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">type</span> <span class="n">SimpleLogic</span> <span class="n">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">l</span> <span class="n">Logger</span>
</span></span><span class="line"><span class="cl">	<span class="n">ds</span> <span class="n">DataStore</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">func</span> <span class="p">(</span><span class="n">sl</span> <span class="n">SimpleLogic</span><span class="p">)</span> <span class="n">SayHello</span><span class="p">(</span><span class="n">userID</span> <span class="n">string</span><span class="p">)</span> <span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">sl</span><span class="o">.</span><span class="n">l</span><span class="o">.</span><span class="n">Log</span><span class="p">(</span><span class="s2">&#34;in SayHello for &#34;</span> <span class="o">+</span> <span class="n">userID</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">name</span><span class="p">,</span> <span class="n">ok</span> <span class="p">:</span><span class="o">=</span> <span class="n">sl</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">UserNameForID</span><span class="p">(</span><span class="n">userID</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="o">!</span><span class="n">ok</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="s2">&#34;&#34;</span><span class="p">,</span> <span class="n">errors</span><span class="o">.</span><span class="n">New</span><span class="p">(</span><span class="s2">&#34;unknown user&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="s2">&#34;Goodbye, &#34;</span> <span class="o">+</span> <span class="n">name</span><span class="p">,</span> <span class="n">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">//</span> <span class="n">Factory</span> <span class="n">function</span> <span class="k">for</span> <span class="n">SimpleLogic</span><span class="o">.</span>
</span></span><span class="line"><span class="cl"><span class="o">//</span> <span class="n">Pass</span> <span class="ow">in</span> <span class="n">interfaces</span> <span class="ow">and</span> <span class="k">return</span> <span class="n">a</span> <span class="n">struct</span><span class="o">.</span>
</span></span><span class="line"><span class="cl"><span class="k">func</span> <span class="n">NewSimpleLogic</span><span class="p">(</span><span class="n">l</span> <span class="n">Logger</span><span class="p">,</span> <span class="n">ds</span> <span class="n">DataStore</span><span class="p">)</span> <span class="n">SimpleLogic</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">SimpleLogic</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">l</span><span class="p">:</span>  <span class="n">l</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="n">ds</span><span class="p">:</span> <span class="n">ds</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">//</span> <span class="n">API</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">type</span> <span class="n">Logic</span> <span class="n">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">SayHello</span><span class="p">(</span><span class="n">userID</span> <span class="n">string</span><span class="p">)</span> <span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">type</span> <span class="n">Controller</span> <span class="n">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">l</span> <span class="n">Logger</span>
</span></span><span class="line"><span class="cl">	<span class="n">logic</span> <span class="n">Logic</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">func</span> <span class="p">(</span><span class="n">c</span> <span class="n">Controller</span><span class="p">)</span> <span class="n">HandleGreeting</span><span class="p">(</span><span class="n">w</span> <span class="n">http</span><span class="o">.</span><span class="n">ResponseWriter</span><span class="p">,</span> <span class="n">r</span> <span class="o">*</span><span class="n">http</span><span class="o">.</span><span class="n">Request</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">c</span><span class="o">.</span><span class="n">l</span><span class="o">.</span><span class="n">Log</span><span class="p">(</span><span class="s2">&#34;In SayHello&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">userID</span> <span class="p">:</span><span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">URL</span><span class="o">.</span><span class="n">Query</span><span class="p">()</span><span class="o">.</span><span class="n">Get</span><span class="p">(</span><span class="s2">&#34;user_id&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">message</span><span class="p">,</span> <span class="n">err</span> <span class="p">:</span><span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">logic</span><span class="o">.</span><span class="n">SayHello</span><span class="p">(</span><span class="n">userID</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="n">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">w</span><span class="o">.</span><span class="n">WriteHeader</span><span class="p">(</span><span class="n">http</span><span class="o">.</span><span class="n">StatusBadRequest</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="n">w</span><span class="o">.</span><span class="n">Write</span><span class="p">([]</span><span class="n">byte</span><span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="n">Error</span><span class="p">()))</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">w</span><span class="o">.</span><span class="n">Write</span><span class="p">([]</span><span class="n">byte</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">//</span> <span class="n">Factory</span> <span class="n">function</span> <span class="k">for</span> <span class="n">Controller</span>
</span></span><span class="line"><span class="cl"><span class="k">func</span> <span class="n">NewController</span><span class="p">(</span><span class="n">l</span> <span class="n">Logger</span><span class="p">,</span> <span class="n">logic</span> <span class="n">Logic</span><span class="p">)</span> <span class="n">Controller</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">Controller</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">l</span><span class="p">:</span> <span class="n">l</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="n">logic</span><span class="p">:</span> <span class="n">logic</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">//</span> <span class="n">main</span><span class="p">:</span> <span class="n">This</span> <span class="n">is</span> <span class="n">the</span> <span class="n">only</span> <span class="n">part</span> <span class="n">of</span> <span class="n">the</span> <span class="n">code</span> <span class="n">that</span> <span class="n">knows</span> <span class="n">what</span> <span class="n">all</span>
</span></span><span class="line"><span class="cl"><span class="o">//</span> <span class="n">the</span> <span class="n">concrete</span> <span class="n">types</span> <span class="n">are</span><span class="o">.</span> <span class="n">To</span> <span class="n">swap</span> <span class="ow">in</span> <span class="n">different</span> <span class="n">implementations</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="o">//</span> <span class="n">this</span> <span class="n">is</span> <span class="n">the</span> <span class="n">only</span> <span class="n">place</span> <span class="n">that</span> <span class="n">needs</span> <span class="n">to</span> <span class="n">change</span><span class="o">.</span>
</span></span><span class="line"><span class="cl"><span class="o">//</span> <span class="n">Try</span><span class="p">:</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">8000</span><span class="o">/</span><span class="n">hello</span><span class="err">?</span><span class="n">user_id</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">l</span> <span class="p">:</span><span class="o">=</span> <span class="n">LoggerAdapter</span><span class="p">(</span><span class="n">LogOutput</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">ds</span> <span class="p">:</span><span class="o">=</span> <span class="n">NewSimpleDataStore</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="n">logic</span> <span class="p">:</span><span class="o">=</span> <span class="n">NewSimpleLogic</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">ds</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">c</span> <span class="p">:</span><span class="o">=</span> <span class="n">NewController</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">logic</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">http</span><span class="o">.</span><span class="n">HandleFunc</span><span class="p">(</span><span class="s2">&#34;/hello&#34;</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">SayHello</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">http</span><span class="o">.</span><span class="n">ListenAndServer</span><span class="p">(</span><span class="s2">&#34;:8000&#34;</span><span class="p">,</span> <span class="n">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><ul>
<li>Dependency injection is a great pattern for making testing easier since you can easily swap out different environments where the inputs and outputs are constrained to validate functionality. For example, you can swap out a database implementation to use hard coded values instead resulting in faster tests.</li>
<li><em>Wire</em>: a dependency injection helper written by Google to automatically crete the concrete type declarations that we wrote ourselves in <em>main</em>.</li>
</ul>
<h2 id="errors">Errors</h2>
<ul>
<li>Errors are favored over exception handling because the execution path is clearer.</li>
<li>Since all variables must be read in Go, returned errors have to either be handled or explicitly ignored.</li>
</ul>
<p><strong>Use Strings for Simple Errors</strong></p>
<ul>
<li><code>errors.New(&quot;only even numbers are processed&quot;)</code> returns an <code>error</code>.</li>
<li><code>fmt.Errorf(&quot;%d isn't an even number&quot;, i)</code> also returns an <code>error</code> but allows you to use formatting.</li>
</ul>
<p><strong>Sentinel Errors</strong></p>
<ul>
<li>Sentinel errors are one of the few variables that are declared at the package level.</li>
<li>By convention, their names start with <em>Err</em> (ex. <em>zip.ErrFormat</em>).</li>
</ul>
<p><strong>Errors Are Values</strong></p>
<ul>
<li>Since <em>error</em> is an interface, you can define your own errors.</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="n">type</span> <span class="n">Status</span> <span class="ne">int</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">const</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="n">InvalidLogin</span> <span class="n">Status</span> <span class="o">=</span> <span class="n">iota</span> <span class="o">+</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">	<span class="n">NotFound</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">type</span> <span class="n">StatusErr</span> <span class="n">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">Status</span> <span class="n">Status</span>
</span></span><span class="line"><span class="cl">	<span class="n">Message</span> <span class="n">string</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">func</span> <span class="p">(</span><span class="n">se</span> <span class="n">StatusErr</span><span class="p">)</span> <span class="n">Error</span><span class="p">()</span> <span class="n">string</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">se</span><span class="o">.</span><span class="n">Message</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">func</span> <span class="n">LoginAndGetData</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="n">pwd</span><span class="p">,</span> <span class="n">file</span> <span class="n">string</span><span class="p">)</span> <span class="p">([]</span><span class="n">byte</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">err</span> <span class="p">:</span><span class="o">=</span> <span class="n">login</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="n">pwd</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="n">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="n">nil</span><span class="p">,</span> <span class="n">StatusErr</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">Status</span><span class="p">:</span> <span class="n">InvalidLogin</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="n">Message</span><span class="p">:</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Sprintf</span><span class="p">(</span><span class="s2">&#34;invalid credentials for user </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">uid</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">data</span><span class="p">,</span> <span class="n">err</span> <span class="p">:</span><span class="o">=</span> <span class="n">getData</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="n">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="n">nil</span><span class="p">,</span> <span class="n">StatusErr</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">Status</span><span class="p">:</span> <span class="n">NotFound</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="n">Message</span><span class="p">:</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Sprintf</span><span class="p">(</span><span class="s2">&#34;file </span><span class="si">%s</span><span class="s2"> not found&#34;</span><span class="p">,</span> <span class="n">file</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="n">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><strong>Wrapping Errors</strong></p>
<ul>
<li>You can wrap an error into another error to add additional context to it.</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="k">func</span> <span class="n">fileChecker</span><span class="p">(</span><span class="n">name</span> <span class="n">string</span><span class="p">)</span> <span class="n">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">f</span><span class="p">,</span> <span class="n">err</span> <span class="p">:</span><span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="n">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s2">&#34;in fileChecker: %w&#34;</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">f</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">err</span> <span class="p">:</span><span class="o">=</span> <span class="n">fileChecker</span><span class="p">(</span><span class="s2">&#34;not_here.txt&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="n">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="n">wrappedErr</span> <span class="p">:</span><span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">Unwrap</span><span class="p">(</span><span class="n">err</span><span class="p">);</span> <span class="n">wrappedErr</span> <span class="o">!=</span> <span class="n">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">wrappedErr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><ul>
<li>You don&rsquo;t usually use <em>errors.Unwrap</em> directly. Use <em>errors.Is</em> and <em>errors.As</em> to find a specific wrapped error instead.</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="k">func</span> <span class="n">fileChecker</span><span class="p">(</span><span class="n">name</span> <span class="n">string</span><span class="p">)</span> <span class="n">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">f</span><span class="p">,</span> <span class="n">err</span> <span class="p">:</span><span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="n">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s2">&#34;in fileChecker: %w&#34;</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">f</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">err</span> <span class="p">:</span><span class="o">=</span> <span class="n">fileChecker</span><span class="p">(</span><span class="s2">&#34;not_here.txt&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="n">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="n">errors</span><span class="o">.</span><span class="n">Is</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">ErrNotExist</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s2">&#34;That file doesn&#39;t exist&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><ul>
<li>The <em>errors.As</em> funciton allows you to check if a returned error matches a specific type.</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="n">err</span> <span class="p">:</span><span class="o">=</span> <span class="n">AFunctionThatReturnsAnError</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="k">var</span> <span class="n">myErr</span> <span class="n">MyErr</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="n">errors</span><span class="o">.</span><span class="n">As</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">myErr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">myErr</span><span class="o">.</span><span class="n">Code</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><ul>
<li>Use <em>errors.Is</em> when you are looking for a specific instance or specific values.</li>
<li>Use <em>errors.As</em> when you are looking for a specific type.</li>
</ul>
<p><strong>panic and recover</strong></p>
<ul>
<li><em>panic</em> and <em>recover</em> look like exception handling but they are not intended to be used that way.</li>
<li>Reserve panics for fatal situations and use recover as a way to gracefully handle those situations.</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="k">func</span> <span class="n">div60</span><span class="p">(</span><span class="n">i</span> <span class="ne">int</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">defer</span> <span class="k">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="n">v</span> <span class="p">:</span><span class="o">=</span> <span class="n">recover</span><span class="p">();</span> <span class="n">v</span> <span class="o">!=</span> <span class="n">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}()</span>
</span></span><span class="line"><span class="cl">	<span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="mi">60</span> <span class="o">/</span><span class="n">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">val</span> <span class="p">:</span><span class="o">=</span> <span class="nb">range</span> <span class="p">[]</span><span class="ne">int</span><span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">}</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">div60</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">//</span> <span class="n">Produces</span><span class="p">:</span>
</span></span><span class="line"><span class="cl"><span class="o">//</span> <span class="mi">60</span>
</span></span><span class="line"><span class="cl"><span class="o">//</span> <span class="mi">30</span>
</span></span><span class="line"><span class="cl"><span class="o">//</span> <span class="n">runtime</span> <span class="n">error</span><span class="p">:</span> <span class="n">integer</span> <span class="n">divide</span> <span class="n">by</span> <span class="n">zero</span>
</span></span><span class="line"><span class="cl"><span class="o">//</span> <span class="mi">10</span>
</span></span></code></pre></div><ul>
<li>If a panic is triggered because the computer is out of a resource like memory or disk space, the safest thing to do is use recover to log the situation and shut down with os.Exit(1).</li>
<li>However, if creating a library for third parties, do not let panics escape the boundaries of your public API. If a panic is possible, a public function should use a recover to convert the panic into an error, return it, and let the calling code decide what to do with them.</li>
</ul>
<p><strong>Getting a Stack Trace from an Error</strong></p>
<ul>
<li>One of the reasons why new Go developers are tempted by panic and recover is that they want to get a stack trace when something goes wrong.</li>
<li>You can use error wrapping to build a call stack by hand, but there are third-party libraries with error types that generate those stacks automatically.</li>
<li>The best known third-party library (<a href="https://github.com/pkg/errors">https://github.com/pkg/errors</a>) provides functions for wrapping errors with stack traces.</li>
<li>If you want to to see the stack trace, use <em>fmt.Printf</em> and the verbose output verb (%+v).</li>
<li>The stack trace output includes the full path to the file. Use <em>-trimpath</em> flag when building your code to replace the full path.</li>
</ul>
<h2 id="modules-packages-and-imports">Modules, Packages, and Imports</h2>
<ul>
<li>Library management in Go is based around three concepts: repositories, modules, and packages.</li>
<li>A repository is a place in a version control system where the source code for a project is stored.</li>
<li>A module is the root of a Go library or application consisting of one or more packages which gives the module organization and structure.</li>
<li>Before you can use code from packages outside of the standard library, make sure that you have declared that your project is a module with a globally unique identifier.
<ul>
<li>In go, this is the path to the module repository (ex. github.com/pkg/errors).</li>
</ul>
</li>
</ul>
<p><strong>go.mod</strong></p>
<ul>
<li>A collection of Go source code becomes a module when there&rsquo;s a valid go.mod file in its root directory.</li>
<li>Run <code>go mod init &lt;module_path&gt;</code> to create the go.mod file that makes the current directory the root of a module.</li>
<li>The <em>require</em> section lists the modules that your module depends on and the minimum version required for each one.</li>
</ul>
<p><strong>Imports and Exports</strong></p>
<ul>
<li><em>import</em> allows you to access exported constants, variables, functions, and types in another package.</li>
<li>Go uses capitalization to determine if a package-lvel identifier is visible outside of the package where it is declared.</li>
<li>Identifiers whose name starts with an uppercase letter is exported.</li>
<li>Anything you export is part of your package&rsquo;s API so ensure that you intend to expose it to clients.</li>
</ul>
<p><strong>Naming Packages</strong></p>
<ul>
<li>Package names should be descriptive.</li>
<li>Don&rsquo;t create a package called <em>util</em>, for example. If it contained two functions referred to as <em>util.ExtractNames</em> and <em>util.FormatNames</em>, the package name tells you nothing about what the functions do.</li>
<li>It&rsquo;s better to create one function called <em>Names</em> in a package called <em>extract</em> and a second function called <em>Names</em> in a package called <em>format</em> with the function calls becoming <em>extract.Names</em> and <em>format.Names</em>.</li>
</ul>
<p><strong>How to Organize Your Module</strong></p>
<ul>
<li>There is no official way to structure Go packages but several patterns have emerged over the years.</li>
<li>When your module is small, keep all of your code in a single package.</li>
<li>If your module consists of one or more applications, create a directory called <em>cmd</em> at the root of your module.
<ul>
<li>Within <em>cmd</em>, create one directory for each binary built from your module.</li>
<li>For example, you might have a module that contains both a web application and a command-line tool that analyzes data in the web application&rsquo;s database.</li>
<li>Use <em>main</em> as the package name within each of these directories.</li>
</ul>
</li>
<li>If your module&rsquo;s root directory contains many files for managing the testing and deployment of your project (Dockerfiles, shell scripts, etc), place all of your Go code (besides the <em>main</em> packages under <em>cmd</em>) into packages under a directory called <em>pkg</em>.</li>
<li>Within the <em>pkg</em> directory, organize your code to limit the dependencies between packages.
<ul>
<li>One common pattern is to organize your code by slices of functionality.</li>
<li>For example, in a shopping site, you might place all of the support customer management code in one package and all of the inventory management code in another.</li>
<li>This helps limit dependencies between packages making it easier to refactor into multiple microservices, if needed.</li>
</ul>
</li>
</ul>
<p><strong>Overriding a Package&rsquo;s Name</strong></p>
<ul>
<li>If packages contain conflicting names, you can override them.</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="n">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="n">crand</span> <span class="s2">&#34;crypto/rand&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s2">&#34;encoding/binary&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s2">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s2">&#34;math/rand&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">func</span> <span class="n">seedRand</span><span class="p">()</span> <span class="o">*</span><span class="n">rand</span><span class="o">.</span><span class="n">Rand</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">var</span> <span class="n">b</span> <span class="p">[</span><span class="mi">8</span><span class="p">]</span><span class="n">byte</span>
</span></span><span class="line"><span class="cl">	<span class="n">_</span><span class="p">,</span> <span class="n">err</span> <span class="p">:</span><span class="o">=</span> <span class="n">crand</span><span class="o">.</span><span class="n">Read</span><span class="p">(</span><span class="n">b</span><span class="p">[:])</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="n">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">panic</span><span class="p">(</span><span class="s2">&#34;cannot seed with cryptographic random number generator&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">r</span> <span class="p">:</span><span class="o">=</span> <span class="n">rand</span><span class="o">.</span><span class="n">New</span><span class="p">(</span><span class="n">rand</span><span class="o">.</span><span class="n">NewSource</span><span class="p">(</span><span class="n">int64</span><span class="p">(</span><span class="n">binary</span><span class="o">.</span><span class="n">LittleEndian</span><span class="o">.</span><span class="n">Uint64</span><span class="p">(</span><span class="n">b</span><span class="p">[:]))))</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">r</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><ul>
<li>Using the package name &ldquo;.&rdquo; places all of the exported identifiers in the imported package into the current package&rsquo;s namespace but this is discouraged for clarity.</li>
</ul>
<p><strong>The internal Package</strong></p>
<ul>
<li>If you need to share a function, type, or constant between packages but don&rsquo;t want to make them part of the API, use the <em>internal</em> package name.</li>
<li>Exported identifiers in the <em>internal</em> package are only accessible to its sibling package and the direct parent package.</li>
</ul>
<p><strong>The init Function: Avoid if Possible</strong></p>
<ul>
<li>Some packages, like database drivers, use <em>init</em> functions to register the database driver through the use of a blank import which uses the underscore as the package name.
<ul>
<li>The underscore is necessary since Go requires you to read all variables when all we need is to trigger the <em>init</em> function within the imported package and don&rsquo;t require access to any of the exported identifiers.</li>
</ul>
</li>
<li>This pattern is considered obsolete since it&rsquo;s unclear that a registration operation is being performed. Instead, register your plugins directly.</li>
</ul>
<p><strong>Circular Dependencies</strong></p>
<ul>
<li>Circular dependencies are sometimes caused by splitting packages up too finely. If two packages depend on each other, there is a good chance they should be merged into a single package.</li>
<li>If there are good reasons to keep the packages separate, move just the items causing the circular dependency to one of the two packages or to a new package.</li>
</ul>
<p><strong>Gracefully Renaming and Reorganizing Your API</strong></p>
<ul>
<li>For functions or methods, just declare a function or method that calls the original.</li>
<li>For constants, declare a new constant with the same type and value but with a different name.</li>
<li>When you want to rename or move and exported type, use an <em>alias</em>.</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">type Foo struct {
</span></span><span class="line"><span class="cl">	x int
</span></span><span class="line"><span class="cl">	S string
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></div><ul>
<li>If you want to allow users to access Foo by the name Bar, all you need is: <code>type Bar = Foo</code>.</li>
</ul>
<p><strong>Working with Versions</strong></p>
<ul>
<li>To declare a specific version in your <em>go.mod</em> file:</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">module region_tax
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">go 1.15
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">require (
</span></span><span class="line"><span class="cl">	github.com/shopspring/decimal v1.2.0
</span></span><span class="line"><span class="cl">)
</span></span></code></pre></div><ul>
<li>To see what versions of the module are available, use the <code>go list</code> command.</li>
<li>Use <em>tags</em> in <em>git</em> to version your modules using the <code>git tag</code> command. Delete a tag using the <code>git tag -d</code> command. Checkout a <em>tag</em> using <code>git checkout</code>.
<ul>
<li>Tagging is generally used to capture a point in history that is used for a marked version release (ex. v1.0.1). A tag is like an immutable branch that doesn&rsquo;t change and will have not further history of commits.</li>
</ul>
</li>
<li>You can change the version of a package by running: <code>go get github.com/shopspring/decimal@v1.0.0</code>. This will change the dependency in <em>go.mod</em>.</li>
<li>Dependencies labeled as <em>// indirect</em> in your <em>go.mod</em> file can be caused by dependencies on older modules that don&rsquo;t have <em>go.mod</em> files themselves or their <em>go.mod</em> files have and error and is missing some of its dependencies.</li>
<li>Another cause of an indirect declaration is if a direct dependency properly specifies an indirect dependency, but it specifies an older version than what&rsquo;s installed in your project. This happens when you explicitly update an indirect dependency with <code>go get</code> or downgrade a dependency&rsquo;s version.</li>
</ul>
<p><strong>Minimum Version Selection</strong></p>
<ul>
<li>You will always get the lowest version of a dependency that is declared to work in all of the <em>go.mod</em> files across all of your dependencies.</li>
<li>If the <em>go.mod</em> files of modules A, B, and C require a module D of versions v1.1.0, v1.2.0, and v1.2.3, Go will import module D only once and will choose v1.2.3 as that is the most recent specified version.
<ul>
<li>This works because Go uses semantic versioning (SemVer) which states that only updates to a major version can break backward compatibility. v1 modules should be compatible whereas v2 modules may not be.</li>
</ul>
</li>
</ul>
<p><strong>Updating to Incompatible Versions</strong></p>
<ul>
<li>A module may have a different directory to store a new major version (ex. v2) and you can import this into your program as <code>import github.com/learning-go-book/simpletax/v2</code>.</li>
<li>Your <em>go.mod</em> file will have new and old versions if different parts of your program require both modules.</li>
<li>To remove unused versions, run <code>go mod tidy</code>.</li>
</ul>
<p><strong>Vendoring</strong></p>
<ul>
<li>To ensure that a module always builds with identical dependencies, you can keep copies of your dependencies using <em>vendoring</em>.</li>
<li>Enable vendoring by running <code>go mod vendor</code> which creates a directory called <em>vendor</em> at the top level of your modules containing all of your module&rsquo;s dependencies.</li>
<li>If new dependencies are added to <em>go.mod</em> or versions are updated with <code>go get</code>, you need to run <code>go mod vendor</code> to update the <em>vendor</em> directory or you will get an error message on build.</li>
<li>This practice is falling out of favor since it dramatically increases your project size and proxy servers now exist to cache your dependencies.</li>
</ul>
<h2 id="concurrency-in-go">Concurrency in Go</h2>
<ul>
<li>Concurrency is not parallelism. Whether or not concurrent code runs in parallel depends on the hardware and if the algorithm allows it.</li>
<li>Use concurrency when you want to combine data from multiple operations that can operate independently.</li>
</ul>
<p><strong>Goroutines</strong></p>
<ul>
<li>A <em>process</em> is an instance of a program that&rsquo;s being run by a computer&rsquo;s operating system. The OS associates resources, such as memory, with the process and makes sure that other processes can&rsquo;t access them.</li>
<li>A process is composed of one or more <em>threads</em>. A thread is a unit of execution that is given some time to execute by the OS scheduler. Threads within a process share acess to resources.</li>
<li>Goroutines are lightweight processes managed by the Go runtime.</li>
<li>Go has its own runtime scheduler to assign goroutines to OS threads. There are benefits to Go having its own scheduler:
<ul>
<li>Goroutine creation is faster than thread creation since you aren&rsquo;t creating an OS-level resource.</li>
<li>Goroutine initial stack sizes are smaller than thread stack sizes and can grow as needed making goroutines more efficient.</li>
<li>Switching between goroutines is faster than switching between threads because it happens entirely within the process instead of using OS calls that are relatively slower.</li>
<li>The scheduler can optimize its decisions since it&rsquo;s part of the Go process.</li>
</ul>
</li>
<li>You can launch thousand of goroutines simultaneously while launching thousands of threads will slow the program.</li>
</ul>
<p><strong>Channels</strong></p>
<ul>
<li>Goroutines communicate using <em>channels</em>: <code>ch := make(chan int)</code>.</li>
<li>When you pass a channel to a function, you are passing a pointer to the channel.</li>
<li>The zero value for a channel is <em>nil</em>.</li>
</ul>
<p><strong>Reading, Writing, and Buffering</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">a := &lt;-ch // reads a value from ch and assigns it to a
</span></span><span class="line"><span class="cl">ch &lt;- b // write the value in b to ch
</span></span></code></pre></div><ul>
<li>Channels are unbuffered by default. A read from an open, unbuffered channel causes the reading goroutine to pause until another goroutine writes to the same channel. This means that you cannot write to or read from an unbuffered channel without at least two concurrently running goroutines.</li>
<li>Buffered channels allow for a limited number of writes without blocking. If the buffer fills before there are any reads from the channel, a subsequent write to the channel pauses the writing goroutine until the channel is read.</li>
<li>Reading from a channel with an empty buffer also blocks.</li>
<li>To create a buffered channel: <code>ch := make(chan int, 10)</code>.</li>
<li>Most of the time, use unbuffered channels.</li>
</ul>
<p><strong>for-range and Channels</strong></p>
<ul>
<li>You can read from a channel using a for-range loop:</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">for v := range ch {
</span></span><span class="line"><span class="cl">	fmt.Println(v)
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></div><ul>
<li>The loop continues until the channel is closed or a break or continue statement is reached.</li>
</ul>
<p><strong>Closing a Channel</strong></p>
<ul>
<li>When done writing to a channel, close it: <code>close(ch)</code>.</li>
<li>Attempting to write to a closed channel will trigger a panic but reads will always succeed.</li>
<li>Reading an empty channel will result in the zero value for the channel&rsquo;s type.</li>
<li>To determine if a channel is closed, use the comma ok idiom: <code>v, ok := &lt;-ch</code> where if ok is true, the channel is open. Use this any time you are reading from a channel that might be closed.</li>
<li>The responsibility for closing a channel lies with the goroutine that writes to the channel.</li>
</ul>
<p><strong>select</strong></p>
<ul>
<li>The <em>select</em> statement is the control structure for concurrency in Go.</li>
<li>The <em>select</em> keyword allows a goroutine to read from or write to one of a set of multiple channels.</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">select {
</span></span><span class="line"><span class="cl">case v := &lt;-ch:
</span></span><span class="line"><span class="cl">	fmt.Println(v)
</span></span><span class="line"><span class="cl">case v := &lt;-ch2:
</span></span><span class="line"><span class="cl">	fmt.Println(v)
</span></span><span class="line"><span class="cl">case ch3 &lt;- x:
</span></span><span class="line"><span class="cl">	fmt.Println(&#34;wrote&#34;, x)
</span></span><span class="line"><span class="cl">case &lt;-ch4:
</span></span><span class="line"><span class="cl">	fmt.Println(&#34;got value on ch4, but ignored it&#34;)
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></div><ul>
<li>Each case in a <em>select</em> is a read or a write to a channel and each case creates its own block.</li>
<li>A <em>select</em> checks its cases at random to see if any can proceed, which helps mitigate deadlocks.</li>
<li><em>select</em> statements are often run in a <em>for</em> loop often called a <em>for-select</em> loop:</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="k">for</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">select</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="o">&lt;-</span><span class="n">done</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="n">v</span> <span class="p">:</span><span class="o">=</span> <span class="o">&lt;-</span><span class="n">ch</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="n">default</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="o">//</span> <span class="n">defaults</span> <span class="ow">in</span> <span class="n">a</span> <span class="k">for</span><span class="o">-</span><span class="n">select</span> <span class="n">loop</span> <span class="n">are</span> <span class="n">almost</span> <span class="n">always</span> <span class="n">the</span> <span class="n">wrong</span> <span class="n">thing</span> <span class="n">to</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">			<span class="o">//</span> <span class="n">since</span> <span class="n">it</span> <span class="n">will</span> <span class="n">be</span> <span class="n">triggered</span> <span class="n">every</span> <span class="n">time</span> <span class="n">through</span> <span class="n">the</span> <span class="n">loop</span> <span class="n">causing</span> <span class="n">the</span>
</span></span><span class="line"><span class="cl">			<span class="o">//</span> <span class="n">loop</span> <span class="n">to</span> <span class="n">run</span> <span class="n">constantly</span><span class="p">,</span> <span class="n">taking</span> <span class="n">up</span> <span class="n">CPU</span> <span class="n">cycles</span><span class="o">.</span>
</span></span><span class="line"><span class="cl">			<span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s2">&#34;no value written to ch&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><strong>Concurrency Practices and Patterns</strong></p>
<p><strong>Keep your APIs Concurrency-Free</strong></p>
<ul>
<li>Never expose (export) channels or mutexes in your API&rsquo;s types, functions, and methods.</li>
<li>If you expose a channel, you put the responsibility of channel management on the users of your API so now they have to be concerned about whether or not a channel is buffered or closed or nil.</li>
</ul>
<p><strong>Goroutines, for Loops, and Varying Variables</strong></p>
<ul>
<li>If you want to avoid shadowing and make the data flow more obvious, you can pass a value to a goroutine as a parameter:</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">for _, v := range a {
</span></span><span class="line"><span class="cl">	go func(val int) {
</span></span><span class="line"><span class="cl">		ch &lt;- val * 2
</span></span><span class="line"><span class="cl">	}(v)
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></div><ul>
<li>This behavior changed in Go version 1.22 where variables in for loops, like in <em>v</em> above, have per-iteration scope instead of per-loop scope since this is a common bug that developers make.</li>
</ul>
<p><strong>Always Clean Up Your Goroutines</strong></p>
<ul>
<li>When launching a goroutine, make sure that it will eventually exit since the Go runtime can&rsquo;t detect if a goroutine will never be used again so it will remain active. This is called a <em>goroutine leak</em>.</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="k">func</span> <span class="n">countTo</span><span class="p">(</span><span class="nb">max</span> <span class="ne">int</span><span class="p">)</span> <span class="o">&lt;-</span><span class="n">chan</span> <span class="ne">int</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">ch</span> <span class="p">:</span><span class="o">=</span> <span class="n">make</span><span class="p">(</span><span class="n">chan</span> <span class="ne">int</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">go</span> <span class="k">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">for</span> <span class="n">i</span> <span class="p">:</span><span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">max</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">ch</span> <span class="o">&lt;-</span> <span class="n">i</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="n">close</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}()</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">ch</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="n">i</span> <span class="p">:</span><span class="o">=</span> <span class="nb">range</span> <span class="n">countTo</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">5</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">break</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><ul>
<li>The <em>break</em> statement exits the loop early causing the goroutine to block forever, waiting for a value to be read from the channel.</li>
</ul>
<p><strong>The Done Channel Pattern</strong></p>
<ul>
<li>Provides a way to signal a goroutine that it&rsquo;s time to stop processing by using a channel to signal that it&rsquo;s time to exit.</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="k">func</span> <span class="n">searchData</span><span class="p">(</span><span class="n">s</span> <span class="n">string</span><span class="p">,</span> <span class="n">searchers</span> <span class="p">[]</span><span class="k">func</span><span class="p">(</span><span class="n">string</span><span class="p">)</span> <span class="p">[]</span><span class="n">string</span><span class="p">)</span> <span class="p">[]</span><span class="n">string</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">done</span> <span class="p">:</span><span class="o">=</span> <span class="n">make</span><span class="p">(</span><span class="n">chan</span> <span class="n">struct</span><span class="p">{})</span> <span class="o">//</span> <span class="n">using</span> <span class="n">an</span> <span class="n">empty</span> <span class="n">struct</span> <span class="n">since</span> <span class="n">the</span> <span class="n">value</span> <span class="n">is</span> <span class="n">unimportant</span>
</span></span><span class="line"><span class="cl">	<span class="n">result</span> <span class="p">:</span><span class="o">=</span> <span class="n">make</span><span class="p">(</span><span class="n">chan</span> <span class="p">[]</span><span class="n">string</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="o">//</span> <span class="n">We</span> <span class="n">only</span> <span class="n">want</span> <span class="n">the</span> <span class="n">result</span> <span class="n">from</span> <span class="n">the</span> <span class="n">fastest</span> <span class="n">function</span>
</span></span><span class="line"><span class="cl">	<span class="o">//</span> <span class="n">so</span> <span class="n">close</span> <span class="n">done</span> <span class="n">as</span> <span class="n">soon</span> <span class="n">as</span> <span class="n">a</span> <span class="n">result</span> <span class="n">is</span> <span class="n">read</span><span class="o">.</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">searcher</span> <span class="p">:</span><span class="o">=</span> <span class="nb">range</span> <span class="n">searchers</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">go</span> <span class="k">func</span><span class="p">(</span><span class="n">searcher</span> <span class="k">func</span><span class="p">(</span><span class="n">string</span><span class="p">)</span> <span class="p">[]</span><span class="n">string</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">select</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">case</span> <span class="n">result</span> <span class="o">&lt;-</span> <span class="n">searcher</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">			<span class="k">case</span> <span class="o">&lt;-</span> <span class="n">done</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}(</span><span class="n">searcher</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">r</span> <span class="p">:</span><span class="o">=</span> <span class="o">&lt;-</span><span class="n">result</span>
</span></span><span class="line"><span class="cl">	<span class="n">close</span><span class="p">(</span><span class="n">done</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">r</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><strong>Using a Cancel Function to Terminate a Goroutine</strong></p>
<ul>
<li>You can also use the <em>done channel pattern</em> to return a cancellation function alongside a channel.</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="k">func</span> <span class="n">countTo</span><span class="p">(</span><span class="nb">max</span> <span class="ne">int</span><span class="p">)</span> <span class="p">(</span><span class="o">&lt;-</span><span class="n">chan</span> <span class="ne">int</span><span class="p">,</span> <span class="k">func</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">ch</span> <span class="p">:</span><span class="o">=</span> <span class="n">make</span><span class="p">(</span><span class="n">chan</span> <span class="ne">int</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">done</span> <span class="p">:</span><span class="o">=</span> <span class="n">make</span><span class="p">(</span><span class="n">chan</span> <span class="n">struct</span><span class="p">{})</span>
</span></span><span class="line"><span class="cl">	<span class="n">cancel</span> <span class="p">:</span><span class="o">=</span> <span class="k">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">close</span><span class="p">(</span><span class="n">done</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">go</span> <span class="k">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">for</span> <span class="n">i</span> <span class="p">:</span><span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">max</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">select</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">case</span> <span class="o">&lt;-</span><span class="n">done</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">				<span class="k">return</span>
</span></span><span class="line"><span class="cl">			<span class="n">default</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">				<span class="n">ch</span> <span class="o">&lt;-</span> <span class="n">i</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="n">close</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}()</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">ch</span><span class="p">,</span> <span class="n">cancel</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">ch</span><span class="p">,</span> <span class="n">cancel</span> <span class="p">:</span><span class="o">=</span> <span class="n">countTo</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="n">i</span> <span class="p">:</span><span class="o">=</span> <span class="nb">range</span> <span class="n">ch</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">5</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">break</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">cancel</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><strong>When to Use Buffered and Unbuffered Channels</strong></p>
<ul>
<li>Buffered channels are useful when you known how many goroutines you have launched, want to limit the number of goroutines you will launch, or want to limit the amount of work that is queued up.</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="k">func</span> <span class="n">processChannel</span><span class="p">(</span><span class="n">ch</span> <span class="n">chan</span> <span class="ne">int</span><span class="p">)</span> <span class="p">[]</span><span class="ne">int</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">const</span> <span class="n">conc</span> <span class="o">=</span> <span class="mi">10</span>
</span></span><span class="line"><span class="cl">	<span class="n">results</span> <span class="p">:</span><span class="o">=</span> <span class="n">make</span><span class="p">(</span><span class="n">chan</span> <span class="ne">int</span><span class="p">,</span> <span class="n">conc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="n">i</span> <span class="p">:</span><span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">conc</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">go</span> <span class="k">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">results</span> <span class="o">&lt;-</span> <span class="n">process</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}()</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">var</span> <span class="n">out</span> <span class="p">[]</span><span class="ne">int</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="n">i</span> <span class="p">:</span><span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">conc</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">out</span> <span class="o">=</span> <span class="n">append</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="o">&lt;-</span><span class="n">results</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">out</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><strong>Backpressure</strong></p>
<ul>
<li>You can use a buffered channel and a <em>select</em> statement to limit the number of simultaneous requests in a system.</li>
<li>We can create a struct that contains a buffered channel with a number of &ldquo;tokens&rdquo; and a function to run. Every time a goroutine wants to use the function, it calls <em>Process</em>. The <em>select</em> tries to read a token from the channel. If it can, the function runs, and the token is returned. If it can&rsquo;t read a token, the <em>default</em> case runs and an error is returned instead.</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="n">type</span> <span class="n">PressureGauge</span> <span class="n">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">ch</span> <span class="n">chan</span> <span class="n">struct</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">func</span> <span class="n">New</span><span class="p">(</span><span class="n">limit</span> <span class="ne">int</span><span class="p">)</span> <span class="o">*</span><span class="n">PressureGauge</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">ch</span> <span class="p">:</span><span class="o">=</span> <span class="n">make</span><span class="p">(</span><span class="n">chan</span> <span class="n">struct</span><span class="p">{},</span> <span class="n">limit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="n">i</span> <span class="p">:</span><span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">limit</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">ch</span> <span class="o">&lt;-</span> <span class="n">struct</span><span class="p">{}{}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="o">&amp;</span><span class="n">PressureGauge</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">ch</span><span class="p">:</span> <span class="n">ch</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">func</span> <span class="p">(</span><span class="n">pg</span> <span class="o">*</span><span class="n">PressureGauge</span><span class="p">)</span> <span class="n">Process</span><span class="p">(</span><span class="n">f</span> <span class="k">func</span><span class="p">())</span> <span class="n">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">select</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="o">&lt;-</span><span class="n">pg</span><span class="o">.</span><span class="n">ch</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="n">f</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="n">pg</span><span class="o">.</span><span class="n">ch</span> <span class="o">&lt;-</span> <span class="n">struct</span><span class="p">{}{}</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="n">nil</span>
</span></span><span class="line"><span class="cl">	<span class="n">default</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="n">errors</span><span class="o">.</span><span class="n">New</span><span class="p">(</span><span class="s2">&#34;no more capacity&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">func</span> <span class="n">doThingThatShouldBeLimited</span><span class="p">()</span> <span class="n">string</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">time</span><span class="o">.</span><span class="n">Sleep</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">time</span><span class="o">.</span><span class="n">Second</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="s2">&#34;done&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">pg</span> <span class="p">:</span><span class="o">=</span> <span class="n">New</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">http</span><span class="o">.</span><span class="n">HandleFunc</span><span class="p">(</span><span class="s2">&#34;/request&#34;</span><span class="p">,</span> <span class="k">func</span><span class="p">(</span><span class="n">w</span> <span class="n">http</span><span class="o">.</span><span class="n">ResponseWriter</span><span class="p">,</span> <span class="n">r</span> <span class="o">*</span><span class="n">http</span><span class="o">.</span><span class="n">Request</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">err</span> <span class="p">:</span><span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="k">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">w</span><span class="o">.</span><span class="n">Write</span><span class="p">([]</span><span class="n">byte</span><span class="p">(</span><span class="n">doThingThatShouldBeLimited</span><span class="p">()))</span>
</span></span><span class="line"><span class="cl">		<span class="p">})</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="n">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">w</span><span class="o">.</span><span class="n">WriteHeader</span><span class="p">(</span><span class="n">http</span><span class="o">.</span><span class="n">StatusTooManyRequests</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="n">w</span><span class="o">.</span><span class="n">Write</span><span class="p">([]</span><span class="n">byte</span><span class="p">(</span><span class="s2">&#34;Too many requests&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">})</span>
</span></span><span class="line"><span class="cl">	<span class="n">http</span><span class="o">.</span><span class="n">ListenAndServe</span><span class="p">(</span><span class="s2">&#34;:8000&#34;</span><span class="p">,</span> <span class="n">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><strong>Turning Off a case in a select</strong></p>
<ul>
<li>If one of the cases in a <em>select</em> is reading a closed channel, it will always be successful, returning the zero value. Every time that case is selected, you need to check to make sure that the value is valid and skip the case. If reads are spaced out, your program is going to waste a lot of time reading junk values. For this case, you can use a <em>nil</em> channel to disable a <em>case</em> in a <em>select</em>.</li>
<li>When you detect that a channel has been closed, set the channel&rsquo;s variable to <em>nil</em>. The associated case will no longer run because the read from the <em>nil</em> channel never returns a value:</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">// in and in2 are channels, done is a done channel.
</span></span><span class="line"><span class="cl">for {
</span></span><span class="line"><span class="cl">	select {
</span></span><span class="line"><span class="cl">	case v, ok := &lt;-in:
</span></span><span class="line"><span class="cl">		if !ok {
</span></span><span class="line"><span class="cl">			in = nil // the case will never succeed again!
</span></span><span class="line"><span class="cl">			continue
</span></span><span class="line"><span class="cl">		}
</span></span><span class="line"><span class="cl">		// process the v that was read from in
</span></span><span class="line"><span class="cl">	case v, ok := &lt;-in2:
</span></span><span class="line"><span class="cl">		if !ok {
</span></span><span class="line"><span class="cl">			in2 = nil // the case will never succeed again!
</span></span><span class="line"><span class="cl">			continue
</span></span><span class="line"><span class="cl">		}
</span></span><span class="line"><span class="cl">		// process the v that was read from in2
</span></span><span class="line"><span class="cl">	case &lt;-done:
</span></span><span class="line"><span class="cl">		return
</span></span><span class="line"><span class="cl">	}
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></div><p><strong>How to Time Out Code</strong></p>
<ul>
<li>Any time you need to limit how long an operation takes in Go, you&rsquo;ll see a variation on this pattern:</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="k">func</span> <span class="n">timeLimit</span><span class="p">()</span> <span class="p">(</span><span class="ne">int</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">var</span> <span class="n">result</span> <span class="ne">int</span>
</span></span><span class="line"><span class="cl">	<span class="k">var</span> <span class="n">err</span> <span class="n">error</span>
</span></span><span class="line"><span class="cl">	<span class="n">done</span> <span class="p">:</span><span class="o">=</span> <span class="n">make</span><span class="p">(</span><span class="n">chan</span> <span class="n">struct</span><span class="p">{})</span>
</span></span><span class="line"><span class="cl">	<span class="n">go</span> <span class="k">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">result</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">doSomeWork</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="n">close</span><span class="p">(</span><span class="n">done</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}()</span>
</span></span><span class="line"><span class="cl">	<span class="n">select</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="o">&lt;-</span><span class="n">done</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="n">result</span><span class="p">,</span> <span class="n">err</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="o">&lt;-</span><span class="n">time</span><span class="o">.</span><span class="n">After</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">time</span><span class="o">.</span><span class="n">Second</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="n">errors</span><span class="o">.</span><span class="n">New</span><span class="p">(</span><span class="s2">&#34;work timed out&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><strong>Using WaitGroups</strong></p>
<ul>
<li>If you are waiting on several goroutines, you need to use a <em>WaitGroup</em>:</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">var</span> <span class="n">wg</span> <span class="n">sync</span><span class="o">.</span><span class="n">WaitGroup</span>
</span></span><span class="line"><span class="cl">	<span class="n">wg</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">go</span> <span class="k">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">defer</span> <span class="n">wg</span><span class="o">.</span><span class="n">Done</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="n">doThing1</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">}()</span>
</span></span><span class="line"><span class="cl">	<span class="n">go</span> <span class="k">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">defer</span> <span class="n">wg</span><span class="o">.</span><span class="n">Done</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="n">doThing2</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">}()</span>
</span></span><span class="line"><span class="cl">	<span class="n">go</span> <span class="k">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">defer</span> <span class="n">wg</span><span class="o">.</span><span class="n">Done</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="n">doThing3</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">}()</span>
</span></span><span class="line"><span class="cl">	<span class="n">wg</span><span class="o">.</span><span class="n">Wait</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><ul>
<li>Don&rsquo;t explicitly pass the <em>sync.WaitGroup</em> since we need to ensure that every place using it is using the same instance. Also, passing the <em>sync.Waitgroup</em> to a goroutine function passes a copy if a pointer is not used so the call to <em>Done</em> won&rsquo;t decrement the original sync.WaitGroup count.</li>
<li>Use a close to capture the <em>sync.WaitGroup</em> to ensure that every goroutine is referring to the same instance.</li>
<li>When you have multiple goroutines writing to the same channel, you need to make sure that the channel being written to is only used once:</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="k">func</span> <span class="n">processAndGather</span><span class="p">(</span><span class="ow">in</span> <span class="o">&lt;-</span><span class="n">chan</span> <span class="ne">int</span><span class="p">,</span> <span class="n">processor</span> <span class="k">func</span><span class="p">(</span><span class="ne">int</span><span class="p">)</span> <span class="ne">int</span><span class="p">,</span> <span class="n">num</span> <span class="ne">int</span><span class="p">)</span> <span class="p">[]</span><span class="ne">int</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">out</span> <span class="p">:</span><span class="o">=</span> <span class="n">make</span><span class="p">(</span><span class="n">chan</span> <span class="ne">int</span><span class="p">,</span> <span class="n">num</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">var</span> <span class="n">wg</span> <span class="n">sync</span><span class="o">.</span><span class="n">WaitGroup</span>
</span></span><span class="line"><span class="cl">	<span class="n">wg</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="n">i</span> <span class="p">:</span><span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">go</span> <span class="k">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">defer</span> <span class="n">wg</span><span class="o">.</span><span class="n">Done</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">			<span class="k">for</span> <span class="n">v</span> <span class="p">:</span><span class="o">=</span> <span class="nb">range</span> <span class="ow">in</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="n">out</span> <span class="o">&lt;-</span> <span class="n">processor</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}()</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">go</span> <span class="k">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">wg</span><span class="o">.</span><span class="n">Wait</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="n">close</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}()</span>
</span></span><span class="line"><span class="cl">	<span class="k">var</span> <span class="n">result</span> <span class="p">[]</span><span class="ne">int</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="n">v</span> <span class="p">:</span><span class="o">=</span> <span class="nb">range</span> <span class="n">out</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">result</span> <span class="o">=</span> <span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">result</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><ul>
<li>In the above example, a monitoring goroutine waits until all of the processing goroutines exit. When they do, the monitoring goroutine calls <em>close</em> on the output channel. The <em>for-range</em> channel loop exits when <em>out</em> is closed and the buffer is empty. Finally, the function returns the processed values.</li>
<li>While <em>WaitGroups</em> are handy, they shouldn&rsquo;t be your first choice when coordinating goroutines. Use them only when you have something to clean up (like closing a channel they all write to) after all of your worker goroutines exit.</li>
</ul>
<p><strong>Running Code Exactly Once</strong></p>
<ul>
<li>Sometimes you want to lazy load, or call some initialization code exactly once after program launch time. This is usually because the initialization is relatively slow and may not even be needed every time your program runs. The <em>sync</em> package includes a handy type called <em>Once</em> that enables this functionality.</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="n">type</span> <span class="n">SlowComplicatedParser</span> <span class="n">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">Parse</span><span class="p">(</span><span class="n">string</span><span class="p">)</span> <span class="n">string</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">var</span> <span class="n">parser</span> <span class="n">SlowComplicatedParser</span>
</span></span><span class="line"><span class="cl"><span class="k">var</span> <span class="n">once</span> <span class="n">sync</span><span class="o">.</span><span class="n">Once</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">func</span> <span class="n">Parse</span><span class="p">(</span><span class="n">dataToParse</span> <span class="n">string</span><span class="p">)</span> <span class="n">string</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">once</span><span class="o">.</span><span class="n">Do</span><span class="p">(</span><span class="k">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">parser</span> <span class="o">=</span> <span class="n">initParser</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">})</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">parser</span><span class="o">.</span><span class="n">Parse</span><span class="p">(</span><span class="n">dataToParse</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">func</span> <span class="n">initParser</span><span class="p">()</span> <span class="n">SlowComplicatedParser</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="o">//</span> <span class="k">do</span> <span class="n">all</span> <span class="n">sorts</span> <span class="n">of</span> <span class="n">setup</span> <span class="ow">and</span> <span class="n">loading</span> <span class="n">here</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><ul>
<li>In the above example, we want to ensure that <em>parser</em> is only initialized once, so we set the value of <em>parser</em> from within a closure that&rsquo;s passed to the <em>Do</em> method on <em>once</em>. If <em>Parse</em> is called more than once, <em>once.Do</em> will not execute the closure again.</li>
</ul>
<p><strong>When to Use Mutexes Instead of Channels</strong></p>
<ul>
<li>The main problem with mutexes is that they obscure the flow of data through a program. In contrast, when a value is passed from goroutine to goroutine over a series of channels, the data flow is clearer.</li>
<li>When a mutex is used to protect a value, there is nothing to indicate which goroutine currently has ownership of the value because access to the value is shared by all of the concurrent processes making it hard to understand the order of processing.
<ul>
<li>&ldquo;Share memory by communicating; do not communcate by sharing memory.&rdquo;</li>
</ul>
</li>
<li>However, sometimes it is clearer to use a mutex.
<ul>
<li>The most common case is when your goroutines read or write a shared value, but don&rsquo;t process the value.</li>
</ul>
</li>
<li>How to decide whether to use channels or mutexes:
<ul>
<li>If you are coordinating goroutines or tracking a value as it is transformed by a series of goroutines, use channels.</li>
<li>If you are sharing access to a field in a struct, use mutexes.</li>
<li>If you discover a critical performance issue when using channels and you cannot find any other way to fix the issu, modify your code to use a mutex.</li>
</ul>
</li>
<li>Mutexes must never be copied. If a mutex is copied, its lock won&rsquo;t be shared.</li>
<li>Never try to access a variable from multiple goroutines unless you acquire a mutext for that variable first since it can cuase odd errors that are hard to trace.</li>
</ul>
<h2 id="the-context">The Context</h2>
<ul>
<li>Context is a way to handle metadata for individual requests.</li>
<li>It can be used to identify a chain of requests with a tracking ID or to set a timer that ends a request that takes too long.</li>
<li>A context is an instance that meets the <em>Context</em> interface defined in the context package.</li>
<li>Idiomatic Go encourages passing the context explicitly and convention has it as the first parameter of a function.</li>
<li>If an existing context doesn&rsquo;t exist, you can create an empty one with <em>context.Background</em> which returns a variable of type <em>context.Context</em>.</li>
<li>Each time you add metadata to the context, you do so by wrapping the existing context with <em>WithContext</em>.</li>
<li><em>WithContext</em> takes in a <em>context.Context</em> and returns a new http.Request with the old request&rsquo;s state combined with the supplied <em>context.Context</em>.</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="n">type</span> <span class="n">userKey</span> <span class="ne">int</span>
</span></span><span class="line"><span class="cl"><span class="k">const</span> <span class="n">key</span> <span class="n">userKey</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">//</span> <span class="n">The</span> <span class="n">name</span> <span class="n">of</span> <span class="n">the</span> <span class="n">function</span> <span class="n">that</span> <span class="n">creates</span> <span class="n">a</span> <span class="n">context</span> <span class="n">with</span> <span class="n">a</span> <span class="n">value</span> <span class="n">should</span>
</span></span><span class="line"><span class="cl"><span class="o">//</span> <span class="n">start</span> <span class="n">with</span> <span class="n">ContextWith</span><span class="o">.</span>
</span></span><span class="line"><span class="cl"><span class="k">func</span> <span class="n">ContextWithUser</span><span class="p">(</span><span class="n">ctx</span> <span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span> <span class="n">user</span> <span class="n">string</span><span class="p">)</span> <span class="n">context</span><span class="o">.</span><span class="n">Context</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">context</span><span class="o">.</span><span class="n">WithValue</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">userKey</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">//</span> <span class="n">The</span> <span class="n">function</span> <span class="n">that</span> <span class="n">returns</span> <span class="n">the</span> <span class="n">value</span> <span class="n">from</span> <span class="n">the</span> <span class="n">context</span> <span class="n">should</span> <span class="n">have</span> <span class="n">a</span>
</span></span><span class="line"><span class="cl"><span class="o">//</span> <span class="n">name</span> <span class="n">that</span> <span class="n">ends</span> <span class="n">with</span> <span class="n">FromContext</span><span class="o">.</span>
</span></span><span class="line"><span class="cl"><span class="k">func</span> <span class="n">UserFromContext</span><span class="p">(</span><span class="n">ctx</span> <span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">)</span> <span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="ne">bool</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">user</span><span class="p">,</span> <span class="n">ok</span> <span class="p">:</span><span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="n">userKey</span><span class="p">)</span><span class="o">.</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">user</span><span class="p">,</span> <span class="n">ok</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">//</span> <span class="n">Not</span> <span class="n">a</span> <span class="n">real</span> <span class="n">implementation</span> <span class="k">for</span> <span class="n">user</span> <span class="n">authentication</span><span class="o">.</span>
</span></span><span class="line"><span class="cl"><span class="k">func</span> <span class="n">extractUser</span><span class="p">(</span><span class="n">req</span> <span class="o">*</span><span class="n">http</span><span class="o">.</span><span class="n">Request</span><span class="p">)</span> <span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">userCookie</span><span class="p">,</span> <span class="n">err</span> <span class="p">:</span><span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">Cookie</span><span class="p">(</span><span class="s2">&#34;user&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="n">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="s2">&#34;&#34;</span><span class="p">,</span> <span class="n">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">userCookie</span><span class="o">.</span><span class="n">Value</span><span class="p">,</span> <span class="n">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">func</span> <span class="n">Middleware</span><span class="p">(</span><span class="n">handler</span> <span class="n">http</span><span class="o">.</span><span class="n">Handler</span><span class="p">)</span> <span class="n">http</span><span class="o">.</span><span class="n">Handler</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">http</span><span class="o">.</span><span class="n">HandlerFunc</span><span class="p">(</span><span class="k">func</span><span class="p">(</span><span class="n">rw</span> <span class="n">http</span><span class="o">.</span><span class="n">ResponseWriter</span><span class="p">,</span> <span class="n">req</span> <span class="o">*</span><span class="n">http</span><span class="o">.</span><span class="n">Request</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">user</span><span class="p">,</span> <span class="n">err</span> <span class="p">:</span><span class="o">=</span> <span class="n">extractUser</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="n">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">rw</span><span class="o">.</span><span class="n">WriteHeader</span><span class="p">(</span><span class="n">http</span><span class="o">.</span><span class="n">StatusUnauthorized</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="n">ctx</span> <span class="p">:</span><span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">Context</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="n">ctx</span> <span class="o">=</span> <span class="n">ContextWithUser</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="n">req</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">WithContext</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="n">handler</span><span class="o">.</span><span class="n">ServeHTTP</span><span class="p">(</span><span class="n">rw</span><span class="p">,</span> <span class="n">req</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">func</span> <span class="p">(</span><span class="n">c</span> <span class="n">Controller</span><span class="p">)</span> <span class="n">handleRequest</span><span class="p">(</span><span class="n">rw</span> <span class="n">http</span><span class="o">.</span><span class="n">ResponseWriter</span><span class="p">,</span> <span class="n">req</span> <span class="o">*</span><span class="n">http</span><span class="o">.</span><span class="n">Request</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">ctx</span> <span class="p">:</span><span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">Context</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="n">user</span><span class="p">,</span> <span class="n">ok</span> <span class="p">:</span><span class="o">=</span> <span class="n">identity</span><span class="o">.</span><span class="n">UserFromContext</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="o">!</span><span class="n">ok</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">rw</span><span class="o">.</span><span class="n">WriteHeader</span><span class="p">(</span><span class="n">http</span><span class="o">.</span><span class="n">StatusInternalServerError</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">data</span> <span class="p">:</span><span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">URL</span><span class="o">.</span><span class="n">Query</span><span class="p">()</span><span class="o">.</span><span class="n">Get</span><span class="p">(</span><span class="s2">&#34;data&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">result</span><span class="p">,</span> <span class="n">err</span> <span class="p">:</span><span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">Logic</span><span class="o">.</span><span class="n">businessLogic</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="n">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">rw</span><span class="o">.</span><span class="n">WriteHeader</span><span class="p">(</span><span class="n">http</span><span class="o">.</span><span class="n">StatusInternalServerError</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="n">rw</span><span class="o">.</span><span class="n">Write</span><span class="p">([]</span><span class="n">byte</span><span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="n">Error</span><span class="p">()))</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">rw</span><span class="o">.</span><span class="n">Write</span><span class="p">([]</span><span class="n">byte</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><ul>
<li>One more situation that uses the <em>WithContext</em> method is when passing a context to an outgoing request:</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">req, err := http.NewRequest(http.MethodGet, &#34;http://example.com?data=&#34;+data, nil)
</span></span><span class="line"><span class="cl">if err != nil {
</span></span><span class="line"><span class="cl">	return &#34;&#34;, err
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">req = req.WithContext(ctx)
</span></span><span class="line"><span class="cl">resp, err := sc.client.Do(req)
</span></span><span class="line"><span class="cl">if err != nil {
</span></span><span class="line"><span class="cl">	return &#34;&#34;, err
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">// Do other stuff
</span></span></code></pre></div><p><strong>Cancellation</strong></p>
<ul>
<li>Create a cancellable context with <em>context.WithCancel</em> which takes a <em>context.Context</em> as a parameter and returns a child context of type <em>context.Context</em> and a <em>context.CancelFunc</em> that is used to cancel the context.</li>
<li>Any time a cancellable context is created, the cancel function must be called. It&rsquo;s fine to call it multiple times since subsequent calls after the first are ignored.</li>
<li>Use a <em>defer</em> to ensure the call.</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="k">var</span> <span class="n">client</span> <span class="o">=</span> <span class="n">http</span><span class="o">.</span><span class="n">Client</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl"><span class="k">func</span> <span class="n">callBoth</span><span class="p">(</span><span class="n">ctx</span> <span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span> <span class="n">errVal</span> <span class="n">string</span><span class="p">,</span> <span class="n">slowURL</span> <span class="n">string</span><span class="p">,</span> <span class="n">fastURL</span> <span class="n">string</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">ctx</span><span class="p">,</span> <span class="n">cancel</span> <span class="p">:</span><span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">WithCancel</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">defer</span> <span class="n">cancel</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">var</span> <span class="n">wg</span> <span class="n">sync</span><span class="o">.</span><span class="n">WaitGroup</span>
</span></span><span class="line"><span class="cl">	<span class="n">wg</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">go</span> <span class="k">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">defer</span> <span class="n">wg</span><span class="o">.</span><span class="n">Done</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="n">err</span> <span class="p">:</span><span class="o">=</span> <span class="n">callServer</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="s2">&#34;slow&#34;</span><span class="p">,</span> <span class="n">slowURL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="n">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">cancel</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}()</span>
</span></span><span class="line"><span class="cl">	<span class="n">go</span> <span class="k">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">defer</span> <span class="n">wg</span><span class="o">.</span><span class="n">Done</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="n">err</span> <span class="p">:</span><span class="o">=</span> <span class="n">callServer</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="s2">&#34;fast&#34;</span><span class="p">,</span> <span class="n">fastURL</span><span class="o">+</span><span class="s2">&#34;?error=&#34;</span><span class="o">+</span><span class="n">errVal</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="n">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">cancel</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}()</span>
</span></span><span class="line"><span class="cl">	<span class="n">wg</span><span class="o">.</span><span class="n">Wait</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s2">&#34;done with both&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><strong>Timers</strong></p>
<ul>
<li>A server can manage its load by:
<ul>
<li>Limiting simultaneous requests.</li>
<li>Limiting how many requests are queued waiting to run.</li>
<li>Limiting how long a request can run.</li>
<li>Limiting the resources a request can use (such as memory or disk space).</li>
</ul>
</li>
<li>The context provides a way to control how long a request runs with <em>context.WithTimeout</em> and <em>context.WithDeadline</em>.
<ul>
<li><em>context.WithTimeout</em> takes an existing context and a <em>time.Duration</em> that specifies the duration until the context is canceled.</li>
<li><em>context.WithDeadline</em> takes an existing context and a <em>time.Time</em> that specifies the time when the context is canceled.</li>
</ul>
</li>
<li>You control how long an individual call takes by creating a child context that wraps a parent context using <em>context.WithTimeout</em> or <em>context.WithDeadline</em>.
<ul>
<li>Any timeout that you sent on the child context is bounded by the timeout set on the parent context; if a parent context times out in two seconds and the child context times out in three seconds, the child will still time out when the parent does.</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">ctx := context.Background()
</span></span><span class="line"><span class="cl">parent, cancel := context.WithTimeout(ctx, 2*time.Second)
</span></span><span class="line"><span class="cl">defer cancel()
</span></span><span class="line"><span class="cl">child, cancel2 := context.WithTimeout(parent, 3*time.Second)
</span></span><span class="line"><span class="cl">defer cancel2()
</span></span><span class="line"><span class="cl">start := time.Now()
</span></span><span class="line"><span class="cl">&lt;-child.Done()
</span></span><span class="line"><span class="cl">end := time.Now()
</span></span><span class="line"><span class="cl">fmt.Println(end.Sub(start))
</span></span><span class="line"><span class="cl">// prints &#34;2s&#34;
</span></span></code></pre></div><p><strong>Values</strong></p>
<ul>
<li>Values are most commonly entered into the context in middleware.
<ul>
<li>Possible situations are extracting a user from a JWT or creating a per-request GUID that is passed through multiple layers of middleware and into your handler and business logic.</li>
</ul>
</li>
<li>You enter values into the context using <em>context.WithValue</em> which takes in a context to wrap, a key to look up the value, and the value itself.</li>
<li>To check if a value is in a context or any of its parents, use the <em>Value</em> method on <em>context.Context</em>.
<ul>
<li>Use the comma ok idiom to type assert the returned value to the correct type.</li>
</ul>
</li>
</ul>
<p><strong>Keys</strong></p>
<ul>
<li>Like the key for a map, the key for a context value must be comparable.</li>
<li>If you use a string or another public type for the type of the key, different packages could create identical keys, resulting in collisions.</li>
<li>Instead, create a new, unexported type for the key, based on an int then declare an unexported constant of that type:</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">type userKey int
</span></span><span class="line"><span class="cl">cont key userKey = 1
</span></span></code></pre></div><ul>
<li>With both the type and the constant of the key being unexported, no code from outside of your package can put data into the context that would cause a collision.</li>
<li>If you need multiple keys, use the <em>iota</em> pattern.</li>
</ul>


</div>
    <div class="post__footer">
      

      
    </div>

    
  </div>

      </main>
    </div><footer class="footer footer__base">
  <ul class="footer__list">
    <li class="footer__item">
      &copy;
      
        David Ado
        2024
      
    </li>
    
  </ul>
</footer>
  
  <script
    type="text/javascript"
    src="/js/medium-zoom.min.1248fa75275e5ef0cbef27e8c1e27dc507c445ae3a2c7d2ed0be0809555dac64.js"
    integrity="sha256-Ekj6dSdeXvDL7yfoweJ9xQfERa46LH0u0L4ICVVdrGQ="
    crossorigin="anonymous"
  ></script>
  
    
      <script async src="https://www.googletagmanager.com/gtag/js?id=G-FZKQND180X"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-FZKQND180X');
        }
      </script>
    
  

</body>
</html>
